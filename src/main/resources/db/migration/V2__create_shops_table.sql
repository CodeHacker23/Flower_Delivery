-- ============================================
-- Это вторая миграция - создает таблицу магазинов
-- Flyway автоматически выполнит этот SQL при запуске приложения
--
-- Таблица shops хранит ДОПОЛНИТЕЛЬНУЮ информацию о магазинах
-- Базовая информация (ФИО, телефон, роль) хранится в таблице users
--
-- Связь: shops.user_id → users.id (FOREIGN KEY)
-- Это значит: "Каждый магазин принадлежит одному пользователю"
--
-- Аналогия:
-- users = паспорт (базовая информация)
-- shops = водительские права (дополнительная информация для магазинов)
-- ============================================

CREATE TABLE IF NOT EXISTS shops (
    -- id - уникальный идентификатор магазина (UUID)
    -- PRIMARY KEY - первичный ключ (как ID паспорта, только для магазина)
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),

    -- user_id - ссылка на пользователя из таблицы users
    -- UUID - тип данных (должен совпадать с users.id)
    -- NOT NULL - обязательно должен быть (каждый магазин принадлежит пользователю)
    -- UNIQUE - один пользователь может быть только одним магазином (1:1 связь)
    --
    -- FOREIGN KEY (user_id) REFERENCES users(id) - это ВНЕШНИЙ КЛЮЧ
    -- Что это значит:
    -- 1. user_id ДОЛЖЕН существовать в таблице users (нельзя создать магазин для несуществующего пользователя)
    -- 2. Если удалить пользователя из users → что делать с магазином?
    --    ON DELETE CASCADE - автоматически удалить магазин (каскадное удаление)
    --
    -- Пример:
    -- Пользователь с id = 'abc-123' существует в users
    -- Можно создать магазин с user_id = 'abc-123' ✅
    -- Пользователь с id = 'xyz-999' НЕ существует в users
    -- НЕЛЬЗЯ создать магазин с user_id = 'xyz-999' ❌ (ошибка FOREIGN KEY constraint)
    --
    -- Почему UNIQUE:
    -- Один пользователь = один магазин (не может быть двух магазинов для одного пользователя)
    -- Это логично: один Telegram аккаунт = один магазин
    user_id UUID NOT NULL UNIQUE REFERENCES users(id) ON DELETE CASCADE,

    -- shop_name - название магазина (например: "Цветы на Ленина", "Роза и Лилии")
    -- VARCHAR(255) - строка максимум 255 символов
    -- NOT NULL - обязательно должно быть (каждый магазин должен иметь название)
    shop_name VARCHAR(255) NOT NULL,

    -- pickup_address - адрес забора товаров (где курьер будет забирать заказы)
    -- VARCHAR(500) - строка максимум 500 символов (адреса могут быть длинными)
    -- NOT NULL - обязательно должен быть (курьер должен знать, куда ехать)
    --
    -- Примеры:
    -- "ул. Ленина, д. 10, офис 5"
    -- "пр. Мира, д. 25, вход со двора"
    pickup_address VARCHAR(500) NOT NULL,

    -- latitude - широта (координата Y на карте)
    -- DECIMAL(10, 8) - десятичное число с точностью:
    --   - 10 цифр всего
    --   - 8 цифр после запятой (точность до метра)
    --   Пример: 55.75581400 (широта Москвы)
    -- NULL - может быть пустым (пока не геокодировали адрес)
    --
    -- Что такое широта:
    -- Координата от -90 до +90 градусов
    -- 0° = экватор
    -- +90° = Северный полюс
    -- -90° = Южный полюс
    -- Москва ≈ 55.75° (севернее экватора)
    latitude DECIMAL(10, 8),

    -- longitude - долгота (координата X на карте)
    -- DECIMAL(11, 8) - десятичное число с точностью:
    --   - 11 цифр всего (долгота может быть больше по модулю)
    --   - 8 цифр после запятой
    --   Пример: 37.61730000 (долгота Москвы)
    -- NULL - может быть пустым (пока не геокодировали адрес)
    --
    -- Что такое долгота:
    -- Координата от -180 до +180 градусов
    -- 0° = Гринвичский меридиан (Лондон)
    -- +180° / -180° = линия перемены дат (Тихий океан)
    -- Москва ≈ 37.62° (восточнее Гринвича)
    longitude DECIMAL(11, 8),

    -- CHECK constraint - проверка валидности координат
    -- Что это делает:
    -- Проверяет, что если координаты указаны, они должны быть в допустимом диапазоне
    --
    -- Условие:
    -- (latitude IS NULL AND longitude IS NULL) - оба пустые (OK, адрес еще не геокодирован)
    -- OR
    -- (latitude BETWEEN -90 AND 90 AND longitude BETWEEN -180 AND 180) - оба в допустимом диапазоне
    --
    -- Примеры:
    -- latitude = NULL, longitude = NULL → ✅ OK (адрес не геокодирован)
    -- latitude = 55.75, longitude = 37.62 → ✅ OK (Москва, валидные координаты)
    -- latitude = 200, longitude = 37.62 → ❌ ОШИБКА (широта не может быть > 90)
    -- latitude = 55.75, longitude = NULL → ❌ ОШИБКА (если указана широта, должна быть и долгота)
    --
    -- Почему это важно:
    -- Защита от "мусорных" данных (нельзя сохранить координаты на Марсе)
    CHECK (
        (latitude IS NULL AND longitude IS NULL) OR
        (latitude BETWEEN -90 AND 90 AND longitude BETWEEN -180 AND 180)
    ),

    -- phone - телефон магазина (может отличаться от телефона пользователя)
    -- VARCHAR(50) - строка максимум 50 символов
    -- NULL - может быть пустым (необязательное поле)
    --
    -- Примеры:
    -- "+79991234567"
    -- "8 (999) 123-45-67"
    -- "тел: 123-45-67"
    phone VARCHAR(50),

    -- is_active - флаг активности магазина
    -- BOOLEAN - логическое значение (true/false)
    -- DEFAULT FALSE - по умолчанию неактивен
    -- NOT NULL - обязательно должно быть значение
    --
    -- Логика:
    -- false = магазин зарегистрирован, но админ еще не активировал (не может создавать заказы)
    -- true = магазин активирован админом (может создавать заказы)
    --
    -- Почему два флага активности:
    -- 1. users.is_active - активен ли пользователь в системе (может ли войти в бота)
    -- 2. shops.is_active - активен ли магазин (может ли создавать заказы)
    --
    -- Пример:
    -- Пользователь активирован (users.is_active = true), но магазин не активирован (shops.is_active = false)
    -- → Пользователь может войти в бота, но не может создавать заказы
    -- → Админ должен отдельно активировать магазин
    is_active BOOLEAN DEFAULT FALSE NOT NULL,

    -- created_at - когда создан магазин
    -- TIMESTAMP - дата и время
    -- DEFAULT CURRENT_TIMESTAMP - автоматически ставит текущую дату/время при создании
    -- NOT NULL - обязательно должно быть значение
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP NOT NULL,

    -- updated_at - когда обновлен магазин
    -- TIMESTAMP - дата и время
    -- DEFAULT CURRENT_TIMESTAMP - автоматически ставит текущую дату/время при создании
    -- NOT NULL - обязательно должно быть значение
    -- (будет обновляться вручную или через триггер в будущем)
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP NOT NULL
);

-- ============================================
-- ИНДЕКСЫ - для быстрого поиска
-- ============================================

-- Индекс на user_id для быстрого поиска магазина по пользователю
-- Зачем:
-- Когда пользователь хочет посмотреть свой магазин, мы ищем: WHERE user_id = 'abc-123'
-- Без индекса: PostgreSQL просматривает ВСЕ строки (медленно, если магазинов много)
-- С индексом: PostgreSQL сразу находит нужную строку (быстро, даже если магазинов миллион)
--
-- Аналогия:
-- Без индекса = искать человека в телефонной книге, читая все страницы подряд
-- С индексом = искать по алфавитному указателю (сразу открываешь нужную страницу)
CREATE INDEX IF NOT EXISTS idx_shops_user_id ON shops(user_id);

-- Индекс на is_active для быстрой фильтрации активных магазинов
-- Зачем:
-- Когда админ хочет посмотреть список активных магазинов: WHERE is_active = true
-- С индексом поиск будет быстрее
CREATE INDEX IF NOT EXISTS idx_shops_is_active ON shops(is_active);

-- Составной индекс на координаты (latitude, longitude) для геопоиска
-- Зачем:
-- Когда нужно найти магазины рядом с точкой на карте:
-- WHERE latitude BETWEEN 55.7 AND 55.8 AND longitude BETWEEN 37.6 AND 37.7
-- С индексом поиск будет быстрее (особенно важно для геопоиска!)
--
-- Почему составной индекс:
-- Мы часто ищем по ОБОИМ координатам одновременно (не по одной)
-- Составной индекс оптимизирует именно такой поиск
CREATE INDEX IF NOT EXISTS idx_shops_coordinates ON shops(latitude, longitude);

-- ============================================
-- КОММЕНТАРИИ - для документации в БД
-- ============================================

COMMENT ON TABLE shops IS 'Таблица магазинов (дополнительная информация для пользователей с ролью SHOP)';
COMMENT ON COLUMN shops.user_id IS 'Ссылка на пользователя из таблицы users (FOREIGN KEY)';
COMMENT ON COLUMN shops.shop_name IS 'Название магазина';
COMMENT ON COLUMN shops.pickup_address IS 'Адрес забора товаров (где курьер забирает заказы)';
COMMENT ON COLUMN shops.latitude IS 'Широта адреса забора (координата Y, от -90 до +90)';
COMMENT ON COLUMN shops.longitude IS 'Долгота адреса забора (координата X, от -180 до +180)';
COMMENT ON COLUMN shops.is_active IS 'Флаг активности магазина (активируется админом)';
