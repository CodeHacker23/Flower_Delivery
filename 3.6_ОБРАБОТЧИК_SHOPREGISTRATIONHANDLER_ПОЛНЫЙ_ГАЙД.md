# üè™ SHOPREGISTRATIONHANDLER ‚Äî –ü–û–õ–ù–´–ô –û–ë–£–ß–ê–Æ–©–ò–ô –ì–ê–ô–î

**–§–∞–π–ª:** `src/main/java/org/example/flower_delivery/handler/ShopRegistrationHandler.java`

–ï–±–∞—Ç—å, —ç—Ç–æ —Å–∞–º—ã–π –∂–∏—Ä–Ω—ã–π –∫–ª–∞—Å—Å –∏–∑ –≤—Å–µ—Ö, —á—Ç–æ –º—ã –ø–∏—Å–∞–ª–∏. –¢—É—Ç –∏ **state machine** (–∫–æ–Ω–µ—á–Ω—ã–π –∞–≤—Ç–æ–º–∞—Ç), –∏ **–º–Ω–æ–≥–æ–ø–æ—Ç–æ—á–Ω–æ—Å—Ç—å**, –∏ **–ø–æ—à–∞–≥–æ–≤—ã–µ –¥–∏–∞–ª–æ–≥–∏**, –∏ **–≤–∞–ª–∏–¥–∞—Ü–∏—è**. –†–∞–∑–±–µ—Ä—ë–º –∫–∞–∂–¥—É—é —Ö—É–π–Ω—é —Ç–∞–∫, —á—Ç–æ–±—ã —Ç—ã –∑–∞–ø–æ–º–Ω–∏–ª –Ω–∞ –≤—Å—é –∂–∏–∑–Ω—å.

---

## üìã –°–û–î–ï–†–ñ–ê–ù–ò–ï

1. [–ü—Ä–æ–±–ª–µ–º–∞: –∫–∞–∫ –∑–∞–ø–æ–º–Ω–∏—Ç—å, —á—Ç–æ —é–∑–µ—Ä –≤–≤—ë–ª?](#–ø—Ä–æ–±–ª–µ–º–∞)
2. [State Machine ‚Äî –∫–æ–Ω–µ—á–Ω—ã–π –∞–≤—Ç–æ–º–∞—Ç –Ω–∞ –ø–∞–ª—å—Ü–∞—Ö](#state-machine)
3. [ConcurrentHashMap ‚Äî –ø–æ—á–µ–º—É –Ω–µ –ø—Ä–æ—Å—Ç–æ HashMap](#concurrenthashmap)
4. [–†–∞–∑–±–æ—Ä –∏–º–ø–æ—Ä—Ç–æ–≤ ‚Äî —á—Ç–æ –æ—Ç–∫—É–¥–∞ –∏ –∑–∞—á–µ–º](#–∏–º–ø–æ—Ä—Ç—ã)
5. [–†–∞–∑–±–æ—Ä –∞–Ω–Ω–æ—Ç–∞—Ü–∏–π –∫–ª–∞—Å—Å–∞](#–∞–Ω–Ω–æ—Ç–∞—Ü–∏–∏)
6. [–†–∞–∑–±–æ—Ä –ø–æ–ª–µ–π –∫–ª–∞—Å—Å–∞](#–ø–æ–ª—è)
7. [–ú–µ—Ç–æ–¥ startRegistration ‚Äî –Ω–∞—á–∞–ª–æ –¥–∏–∞–ª–æ–≥–∞](#startregistration)
8. [–ú–µ—Ç–æ–¥ handleMessage ‚Äî —Ä–æ—É—Ç–µ—Ä —Å–æ–æ–±—â–µ–Ω–∏–π](#handlemessage)
9. [–ú–µ—Ç–æ–¥—ã handleShopName/Address/Phone ‚Äî –æ–±—Ä–∞–±–æ—Ç–∫–∞ —à–∞–≥–æ–≤](#–æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏-—à–∞–≥–æ–≤)
10. [–í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ –º–µ—Ç–æ–¥—ã](#–≤—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ-–º–µ—Ç–æ–¥—ã)
11. [–ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ –∑–∞–¥–∞–Ω–∏—è](#–ø—Ä–∞–∫—Ç–∏–∫–∞)

---

# –ü–†–û–ë–õ–ï–ú–ê

## –ü–æ—á–µ–º—É –Ω–µ–ª—å–∑—è –ø—Ä–æ—Å—Ç–æ —Å–ø—Ä–æ—Å–∏—Ç—å –≤—Å—ë —Å—Ä–∞–∑—É?

Telegram ‚Äî —ç—Ç–æ –Ω–µ —Ñ–æ—Ä–º–∞ –Ω–∞ —Å–∞–π—Ç–µ, –≥–¥–µ —é–∑–µ—Ä –∑–∞–ø–æ–ª–Ω—è–µ—Ç 10 –ø–æ–ª–µ–π –∏ –∂–º—ë—Ç "–û—Ç–ø—Ä–∞–≤–∏—Ç—å". –¢—É—Ç **–æ–¥–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ = –æ–¥–∏–Ω –æ—Ç–≤–µ—Ç**.

–ë–æ—Ç —Å–ø—Ä–∞—à–∏–≤–∞–µ—Ç ‚Üí —é–∑–µ—Ä –æ—Ç–≤–µ—á–∞–µ—Ç ‚Üí –±–æ—Ç —Å–ø—Ä–∞—à–∏–≤–∞–µ—Ç —Å–ª–µ–¥—É—é—â–µ–µ ‚Üí –∏ —Ç.–¥.

**–ü—Ä–æ–±–ª–µ–º–∞:** –∫–æ–≥–¥–∞ –ø—Ä–∏—Ö–æ–¥–∏—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ "—É–ª. –õ–µ–Ω–∏–Ω–∞, 10" ‚Äî –∫–∞–∫ –±–æ—Ç –ø–æ–Ω–∏–º–∞–µ—Ç, —á—Ç–æ —ç—Ç–æ **–∞–¥—Ä–µ—Å**, –∞ –Ω–µ **–Ω–∞–∑–≤–∞–Ω–∏–µ –º–∞–≥–∞–∑–∏–Ω–∞**?

## –ê–Ω–∞–ª–æ–≥–∏—è: –°—É—Ç–µ–Ω—ë—Ä –∏ –∞–Ω–∫–µ—Ç–∞

–ü—Ä–µ–¥—Å—Ç–∞–≤—å: —Ç—ã —Å—É—Ç–µ–Ω—ë—Ä, –∏ –∫ —Ç–µ–±–µ –ø—Ä–∏—Ö–æ–¥–∏—Ç –Ω–æ–≤–∞—è –¥–µ–≤–æ—á–∫–∞ –Ω–∞ —Å–æ–±–µ—Å–µ–¥–æ–≤–∞–Ω–∏–µ. –¢—ã —Å–ø—Ä–∞—à–∏–≤–∞–µ—à—å –ø–æ –æ—á–µ—Ä–µ–¥–∏:

```
–°—É—Ç–µ–Ω—ë—Ä: –ö–∞–∫ —Ç–µ–±—è –∑–æ–≤—É—Ç?
–î–µ–≤–æ—á–∫–∞: –ê–Ω–∂–µ–ª–∞
–°—É—Ç–µ–Ω—ë—Ä: *–∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç –≤ –±–ª–æ–∫–Ω–æ—Ç* –ö–∞–∫–æ–π —É —Ç–µ–±—è —Ä–∞–∑–º–µ—Ä?
–î–µ–≤–æ—á–∫–∞: 3-–π
–°—É—Ç–µ–Ω—ë—Ä: *–∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç* –ö–∞–∫–æ–π –≥—Ä–∞—Ñ–∏–∫ —É–¥–æ–±–µ–Ω?
–î–µ–≤–æ—á–∫–∞: –° 20:00 –¥–æ 02:00
–°—É—Ç–µ–Ω—ë—Ä: *–∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç* –û—Ç–ª–∏—á–Ω–æ, —Ç—ã –ø—Ä–∏–Ω—è—Ç–∞!
```

**–ö–ª—é—á–µ–≤–æ–π –º–æ–º–µ–Ω—Ç:** —Å—É—Ç–µ–Ω—ë—Ä **–ø–æ–º–Ω–∏—Ç**, —á—Ç–æ –æ–Ω —É–∂–µ —Å–ø—Ä–æ—Å–∏–ª –∏–º—è, –∏ —Ç–µ–ø–µ—Ä—å –∂–¥—ë—Ç —Ä–∞–∑–º–µ—Ä. –ö–æ–≥–¥–∞ –¥–µ–≤–æ—á–∫–∞ –≥–æ–≤–æ—Ä–∏—Ç "3-–π" ‚Äî –æ–Ω –∑–Ω–∞–µ—Ç, —á—Ç–æ —ç—Ç–æ —Ä–∞–∑–º–µ—Ä, –∞ –Ω–µ –∏–º—è.

**–ö–∞–∫ –æ–Ω –ø–æ–º–Ω–∏—Ç?** –£ –Ω–µ–≥–æ –≤ –≥–æ–ª–æ–≤–µ (–∏–ª–∏ –≤ –±–ª–æ–∫–Ω–æ—Ç–µ) –∑–∞–ø–∏—Å–∞–Ω–æ:
- –¢–µ–∫—É—â–∏–π —à–∞–≥: `–ñ–Å–õ–¢–´–ô` (–∂–¥—ë–º —Ä–∞–∑–º–µ—Ä)
- –£–∂–µ –∏–∑–≤–µ—Å—Ç–Ω–æ: –∏–º—è = "–ê–Ω–∂–µ–ª–∞"

–í–æ—Ç —ç—Ç–æ –∏ –µ—Å—Ç—å **State Management** ‚Äî —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º.

---

# STATE MACHINE

## –ß—Ç–æ —Ç–∞–∫–æ–µ –∫–æ–Ω–µ—á–Ω—ã–π –∞–≤—Ç–æ–º–∞—Ç (FSM)?

**Finite State Machine** ‚Äî —ç—Ç–æ —Ö—É–π–Ω—è —Å –∫–æ–Ω–µ—á–Ω—ã–º —á–∏—Å–ª–æ–º —Å–æ—Å—Ç–æ—è–Ω–∏–π –∏ –ø–µ—Ä–µ—Ö–æ–¥–∞–º–∏ –º–µ–∂–¥—É –Ω–∏–º–∏.

### –ü—Ä–∏–º–µ—Ä: —Å–≤–µ—Ç–æ—Ñ–æ—Ä

```
     ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
     ‚îÇ                              ‚îÇ
     ‚ñº                              ‚îÇ
  [–ö–†–ê–°–ù–´–ô] ‚îÄ‚îÄ(—Ç–∞–π–º–µ—Ä)‚îÄ‚îÄ> [–ñ–Å–õ–¢–´–ô] ‚îÄ‚îÄ(—Ç–∞–π–º–µ—Ä)‚îÄ‚îÄ> [–ó–ï–õ–Å–ù–´–ô]
                                                    ‚îÇ
                                                    ‚îÇ
     ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ(—Ç–∞–π–º–µ—Ä)‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
     ‚ñº
  [–ñ–Å–õ–¢–´–ô] ‚îÄ‚îÄ(—Ç–∞–π–º–µ—Ä)‚îÄ‚îÄ> [–ö–†–ê–°–ù–´–ô]
```

–°–≤–µ—Ç–æ—Ñ–æ—Ä:
- –ò–º–µ–µ—Ç **—Å–æ—Å—Ç–æ—è–Ω–∏—è**: –ö–†–ê–°–ù–´–ô, –ñ–Å–õ–¢–´–ô, –ó–ï–õ–Å–ù–´–ô.
- –ò–º–µ–µ—Ç **–ø–µ—Ä–µ—Ö–æ–¥—ã**: –ø–æ —Ç–∞–π–º–µ—Ä—É –ø–µ—Ä–µ–∫–ª—é—á–∞–µ—Ç—Å—è.
- –í—Å–µ–≥–¥–∞ –≤ **–æ–¥–Ω–æ–º** —Å–æ—Å—Ç–æ—è–Ω–∏–∏.

### –ù–∞—à State Machine: —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –º–∞–≥–∞–∑–∏–Ω–∞

```
                    /register_shop
                         ‚îÇ
                         ‚ñº
               ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
               ‚îÇ WAITING_SHOP_   ‚îÇ
               ‚îÇ     NAME        ‚îÇ ‚óÑ‚îÄ‚îÄ‚îÄ‚îÄ "—Å–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–æ–µ!"
               ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò       (–æ—Å—Ç–∞—ë–º—Å—è —Ç—É—Ç)
                        ‚îÇ
                   –≤–≤—ë–ª –Ω–∞–∑–≤–∞–Ω–∏–µ
                        ‚îÇ
                        ‚ñº
               ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
               ‚îÇ WAITING_PICKUP_ ‚îÇ
               ‚îÇ    ADDRESS      ‚îÇ ‚óÑ‚îÄ‚îÄ‚îÄ‚îÄ "—Å–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–∏–π!"
               ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                        ‚îÇ
                    –≤–≤—ë–ª –∞–¥—Ä–µ—Å
                        ‚îÇ
                        ‚ñº
               ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
               ‚îÇ WAITING_PHONE   ‚îÇ ‚óÑ‚îÄ‚îÄ‚îÄ‚îÄ "–Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π —Ç–µ–ª–µ—Ñ–æ–Ω!"
               ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                        ‚îÇ
                –≤–≤—ë–ª —Ç–µ–ª–µ—Ñ–æ–Ω –∏–ª–∏ /skip
                        ‚îÇ
                        ‚ñº
               ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
               ‚îÇ     NONE        ‚îÇ  ‚Üê –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞
               ‚îÇ (–Ω–µ –≤ –¥–∏–∞–ª–æ–≥–µ)  ‚îÇ
               ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

**–°–æ—Å—Ç–æ—è–Ω–∏—è:**
- `WAITING_SHOP_NAME` ‚Äî –∂–¥—ë–º –Ω–∞–∑–≤–∞–Ω–∏–µ.
- `WAITING_PICKUP_ADDRESS` ‚Äî –∂–¥—ë–º –∞–¥—Ä–µ—Å.
- `WAITING_PHONE` ‚Äî –∂–¥—ë–º —Ç–µ–ª–µ—Ñ–æ–Ω.
- `NONE` ‚Äî —é–∑–µ—Ä –Ω–µ –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏.

**–ü–µ—Ä–µ—Ö–æ–¥—ã:**
- –í–≤—ë–ª –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ ‚Üí —Å–ª–µ–¥—É—é—â–∏–π —à–∞–≥.
- –í–≤—ë–ª —Ö—É–π–Ω—é ‚Üí –æ—Å—Ç–∞—ë–º—Å—è –Ω–∞ —Ç–æ–º –∂–µ —à–∞–≥–µ (–≤–∞–ª–∏–¥–∞—Ü–∏—è –Ω–µ –ø—Ä–æ—à–ª–∞).

---

# CONCURRENTHASHMAP

## –ü–æ—á–µ–º—É –Ω–µ –ø—Ä–æ—Å—Ç–æ HashMap?

```java
private final Map<Long, ShopRegistrationData> registrationDataMap = new ConcurrentHashMap<>();
```

### –ü—Ä–æ–±–ª–µ–º–∞: –º–Ω–æ–≥–æ–ø–æ—Ç–æ—á–Ω–æ—Å—Ç—å

Telegram –º–æ–∂–µ—Ç —Å–ª–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è –æ—Ç **—Ä–∞–∑–Ω—ã—Ö —é–∑–µ—Ä–æ–≤ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ**. –ö–∞–∂–¥–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–º –ø–æ—Ç–æ–∫–µ.

**–°—Ü–µ–Ω–∞—Ä–∏–π –ø–∏–∑–¥–µ—Ü–∞ —Å –æ–±—ã—á–Ω—ã–º HashMap:**

```
–ü–æ—Ç–æ–∫ 1 (—é–∑–µ—Ä –í–∞—Å—è):     –ü–æ—Ç–æ–∫ 2 (—é–∑–µ—Ä –ü–µ—Ç—è):
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ      ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
map.put(123, data1)      
                         map.put(456, data2)
map.get(123) ‚Üí ???       
```

–ß—Ç–æ –≤–µ—Ä–Ω—ë—Ç `map.get(123)`? –•—É–π –∑–Ω–∞–µ—Ç! –ú–æ–∂–µ—Ç `data1`, –º–æ–∂–µ—Ç `null`, –∞ –º–æ–∂–µ—Ç –≤–æ–æ–±—â–µ `ConcurrentModificationException` –ø—Ä–∏–ª–µ—Ç–µ—Ç—å.

**HashMap** –Ω–µ –ø–æ—Ç–æ–∫–æ–±–µ–∑–æ–ø–∞—Å–µ–Ω ‚Äî –µ—Å–ª–∏ –¥–≤–∞ –ø–æ—Ç–æ–∫–∞ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ –ª–µ–∑—É—Ç –≤–Ω—É—Ç—Ä—å, –º–æ–∂–µ—Ç —Å–ª—É—á–∏—Ç—å—Å—è:
- –ü–æ—Ç–µ—Ä—è –¥–∞–Ω–Ω—ã—Ö.
- –ë–µ—Å–∫–æ–Ω–µ—á–Ω—ã–π —Ü–∏–∫–ª (–¥–∞, —Ä–µ–∞–ª—å–Ω–æ!).
- Corrupted state.

### –†–µ—à–µ–Ω–∏–µ: ConcurrentHashMap

**ConcurrentHashMap** ‚Äî —ç—Ç–æ HashMap —Å –∑–∞—â–∏—Ç–æ–π –æ—Ç –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞.

–í–Ω—É—Ç—Ä–∏ –æ–Ω —Ä–∞–∑–¥–µ–ª—ë–Ω –Ω–∞ **—Å–µ–≥–º–µ–Ω—Ç—ã**. –ö–æ–≥–¥–∞ –ø–æ—Ç–æ–∫ 1 –ø–∏—à–µ—Ç –≤ —Å–µ–≥–º–µ–Ω—Ç A, –ø–æ—Ç–æ–∫ 2 –º–æ–∂–µ—Ç —Å–ø–æ–∫–æ–π–Ω–æ —á–∏—Ç–∞—Ç—å/–ø–∏—Å–∞—Ç—å –≤ —Å–µ–≥–º–µ–Ω—Ç B.

**–ê–Ω–∞–ª–æ–≥–∏—è:**
- `HashMap` ‚Äî –æ–¥–∏–Ω —Ç—É–∞–ª–µ—Ç –Ω–∞ –≤—Å–µ—Ö. –û—á–µ—Ä–µ–¥—å, —Ç–æ–ª–∫–æ—Ç–Ω—è, —Å—Ä–∞—á.
- `ConcurrentHashMap` ‚Äî –º–Ω–æ–≥–æ –∫–∞–±–∏–Ω–æ–∫. –ö–∞–∂–¥—ã–π –∑–∞–Ω–∏–º–∞–µ—Ç —Å–≤–æ—é, –Ω–∏–∫—Ç–æ –Ω–∏–∫–æ–º—É –Ω–µ –º–µ—à–∞–µ—Ç.

### –ö–æ–≥–¥–∞ –Ω—É–∂–µ–Ω ConcurrentHashMap:

| –°–∏—Ç—É–∞—Ü–∏—è | –ß—Ç–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å |
|----------|------------------|
| –û–¥–∏–Ω –ø–æ—Ç–æ–∫ (–∫–æ–Ω—Å–æ–ª—å–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ) | `HashMap` |
| –ú–Ω–æ–≥–æ –ø–æ—Ç–æ–∫–æ–≤, –Ω–æ —Ç–æ–ª—å–∫–æ —á–∏—Ç–∞—é—Ç | `HashMap` (—á–∏—Ç–∞—Ç—å –±–µ–∑–æ–ø–∞—Å–Ω–æ) |
| –ú–Ω–æ–≥–æ –ø–æ—Ç–æ–∫–æ–≤, –∏ —á–∏—Ç–∞—é—Ç –∏ –ø–∏—à—É—Ç | `ConcurrentHashMap` |
| –ù—É–∂–Ω—ã —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–æ–Ω–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ | `Collections.synchronizedMap()` –∏–ª–∏ `ConcurrentHashMap` |

–í Telegram-–±–æ—Ç–µ **–≤—Å–µ–≥–¥–∞** –º–Ω–æ–≥–æ –ø–æ—Ç–æ–∫–æ–≤ ‚Üí **–≤—Å–µ–≥–¥–∞** `ConcurrentHashMap`.

---

# –ò–ú–ü–û–†–¢–´

–î–∞–≤–∞–π —Ä–∞–∑–±–µ—Ä—ë–º –∫–∞–∂–¥—ã–π –∏–º–ø–æ—Ä—Ç ‚Äî –æ—Ç–∫—É–¥–∞ –æ–Ω –∏ –∑–∞—á–µ–º.

```java
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
```
**Lombok** ‚Äî –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä–∞ –∏ –ª–æ–≥–≥–µ—Ä–∞. –£–∂–µ –∑–Ω–∞–µ–º.

```java
import org.example.flower_delivery.Bot;
```
**–ù–∞—à –∫–ª–∞—Å—Å –±–æ—Ç–∞** ‚Äî –Ω—É–∂–µ–Ω –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π (`bot.execute(...)`).

```java
import org.example.flower_delivery.model.RegistrationState;
import org.example.flower_delivery.model.Shop;
import org.example.flower_delivery.model.ShopRegistrationData;
```
**–ù–∞—à–∏ –º–æ–¥–µ–ª–∏:**
- `RegistrationState` ‚Äî enum —Å —Å–æ—Å—Ç–æ—è–Ω–∏—è–º–∏.
- `Shop` ‚Äî —Å—É—â–Ω–æ—Å—Ç—å –º–∞–≥–∞–∑–∏–Ω–∞ (–ø–æ–ª—É—á–∞–µ–º –ø–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è).
- `ShopRegistrationData` ‚Äî –≤—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏.

```java
import org.example.flower_delivery.service.ShopService;
```
**–°–µ—Ä–≤–∏—Å –º–∞–≥–∞–∑–∏–Ω–æ–≤** ‚Äî –¥—ë—Ä–≥–∞–µ–º `createShopForUser()` –≤ –∫–æ–Ω—Ü–µ.

```java
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.context.annotation.Lazy;
import org.springframework.stereotype.Component;
```
**Spring:**
- `@Autowired` ‚Äî –∏–Ω–∂–µ–∫—Ü–∏—è –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏.
- `@Lazy` ‚Äî –ª–µ–Ω–∏–≤–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è (–∏–∑-–∑–∞ circular dependency —Å Bot).
- `@Component` ‚Äî "—ç—Ç–æ Spring-–±–∏–Ω, —Å–æ–∑–¥–∞–π –∏ –ø–æ–ª–æ–∂–∏ –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä".

```java
import org.telegram.telegrambots.meta.api.methods.send.SendMessage;
import org.telegram.telegrambots.meta.api.objects.Update;
import org.telegram.telegrambots.meta.exceptions.TelegramApiException;
```
**Telegram Bot API:**
- `SendMessage` ‚Äî –æ–±—ä–µ–∫—Ç –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è.
- `Update` ‚Äî –≤—Ö–æ–¥—è—â–µ–µ —Å–æ–±—ã—Ç–∏–µ (—Å–æ–æ–±—â–µ–Ω–∏–µ, callback, –∏ —Ç.–¥.).
- `TelegramApiException` ‚Äî –∏—Å–∫–ª—é—á–µ–Ω–∏–µ –ø—Ä–∏ –æ—à–∏–±–∫–µ –æ—Ç–ø—Ä–∞–≤–∫–∏.

```java
import java.util.Map;
import java.util.concurrent.ConcurrentHashMap;
```
**Java Collections:**
- `Map` ‚Äî –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å (–∏—Å–ø–æ–ª—å–∑—É–µ–º –∫–∞–∫ —Ç–∏–ø –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π).
- `ConcurrentHashMap` ‚Äî —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è (–ø–æ—Ç–æ–∫–æ–±–µ–∑–æ–ø–∞—Å–Ω–∞—è).

---

# –ê–ù–ù–û–¢–ê–¶–ò–ò

```java
@Slf4j
@Component
@RequiredArgsConstructor
public class ShopRegistrationHandler {
```

## @Slf4j

–ì–µ–Ω–µ—Ä–∏—Ç –ø–æ–ª–µ `log` –¥–ª—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è.

```java
// –≠—Ç–æ –ø–æ—è–≤–ª—è–µ—Ç—Å—è "–º–∞–≥–∏—á–µ—Å–∫–∏":
private static final Logger log = LoggerFactory.getLogger(ShopRegistrationHandler.class);
```

–ò—Å–ø–æ–ª—å–∑—É–µ–º:
```java
log.info("–ù–∞—á–∞–ª–æ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏: telegramId={}", telegramId);
log.debug("–û–±—Ä–∞–±–æ—Ç–∫–∞ —à–∞–≥–∞: state={}", state);
log.error("–û—à–∏–±–∫–∞: {}", e.getMessage(), e);
```

## @Component

–ì–æ–≤–æ—Ä–∏—Ç Spring: "–≠—Ç–æ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç, —Å–æ–∑–¥–∞–π –µ–≥–æ —ç–∫–∑–µ–º–ø–ª—è—Ä –∏ –ø–æ–ª–æ–∂–∏ –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä".

**–ü–æ—á–µ–º—É –Ω–µ @Service?**
- `@Service` ‚Äî –¥–ª—è –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∏ (ShopService, UserService).
- `@Component` ‚Äî –¥–ª—è –≤—Å–µ–≥–æ –æ—Å—Ç–∞–ª—å–Ω–æ–≥–æ (—Ö–µ–Ω–¥–ª–µ—Ä—ã, —É—Ç–∏–ª–∏—Ç—ã).

–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏ –æ–¥–Ω–æ –∏ —Ç–æ –∂–µ, –Ω–æ —Å–µ–º–∞–Ω—Ç–∏–∫–∞ —Ä–∞–∑–Ω–∞—è.

## @RequiredArgsConstructor

–ì–µ–Ω–µ—Ä–∏—Ç –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä –¥–ª—è `final` –ø–æ–ª–µ–π:

```java
// Lombok –≥–µ–Ω–µ—Ä–∏—Ç:
public ShopRegistrationHandler(ShopService shopService) {
    this.shopService = shopService;
}
```

**–í–Ω–∏–º–∞–Ω–∏–µ:** `registrationDataMap` –Ω–µ –ø–æ–ø–∞–¥–∞–µ—Ç –≤ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä, –ø–æ—Ç–æ–º—É —á—Ç–æ **–∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç—Å—è –Ω–∞ –º–µ—Å—Ç–µ**:

```java
private final Map<Long, ShopRegistrationData> registrationDataMap = new ConcurrentHashMap<>();
```

Lombok —É–º–Ω—ã–π ‚Äî –≤–∏–¥–∏—Ç, —á—Ç–æ –ø–æ–ª–µ —É–∂–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–æ, –∏ –Ω–µ –¥–æ–±–∞–≤–ª—è–µ—Ç –µ–≥–æ –≤ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä.

---

# –ü–û–õ–Ø

```java
private final ShopService shopService;

@Autowired
@Lazy
private Bot bot;

private final Map<Long, ShopRegistrationData> registrationDataMap = new ConcurrentHashMap<>();
```

## shopService

**–ß—Ç–æ —ç—Ç–æ:** –°–µ—Ä–≤–∏—Å –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –º–∞–≥–∞–∑–∏–Ω–∞–º–∏.  
**–ó–∞—á–µ–º:** –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —É–∂–µ –º–∞–≥–∞–∑–∏–Ω (`findByUserTelegramId`), —Å–æ–∑–¥–∞—ë–º –º–∞–≥–∞–∑–∏–Ω (`createShopForUser`).  
**–ö–∞–∫ –∏–Ω–∂–µ–∫—Ç–∏—Ç—Å—è:** –ß–µ—Ä–µ–∑ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä (—Å–ø–∞—Å–∏–±–æ `@RequiredArgsConstructor`).

## bot

**–ß—Ç–æ —ç—Ç–æ:** –ù–∞—à Telegram-–±–æ—Ç.  
**–ó–∞—á–µ–º:** –û—Ç–ø—Ä–∞–≤–ª—è—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è (`bot.execute(sendMessage)`).  
**–ö–∞–∫ –∏–Ω–∂–µ–∫—Ç–∏—Ç—Å—è:** –ß–µ—Ä–µ–∑ `@Autowired` (–Ω–µ —á–µ—Ä–µ–∑ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä!).

### –ü–æ—á–µ–º—É @Autowired, –∞ –Ω–µ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä?

**Circular Dependency** ‚Äî –∫—Ä—É–≥–æ–≤–∞—è –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å:
- `Bot` –∑–∞–≤–∏—Å–∏—Ç –æ—Ç `ShopRegistrationHandler`.
- `ShopRegistrationHandler` –∑–∞–≤–∏—Å–∏—Ç –æ—Ç `Bot`.

Spring –æ—Ö—É–µ–≤–∞–µ—Ç: "–ß—Ç–æ–±—ã —Å–æ–∑–¥–∞—Ç—å Bot, –º–Ω–µ –Ω—É–∂–µ–Ω ShopRegistrationHandler. –ß—Ç–æ–±—ã —Å–æ–∑–¥–∞—Ç—å ShopRegistrationHandler, –º–Ω–µ –Ω—É–∂–µ–Ω Bot. –ë–ª—è—Ç—å, —á—Ç–æ –¥–µ–ª–∞—Ç—å?"

**@Lazy —Ä–µ—à–∞–µ—Ç –ø—Ä–æ–±–ª–µ–º—É:**
- Spring —Å–æ–∑–¥–∞—ë—Ç `ShopRegistrationHandler` –±–µ–∑ `Bot`.
- –ö–æ–≥–¥–∞ –ø–µ—Ä–≤—ã–π —Ä–∞–∑ –æ–±—Ä–∞—â–∞–µ–º—Å—è –∫ `bot` ‚Äî Spring –∏–Ω–∂–µ–∫—Ç–∏—Ç –µ–≥–æ.
- –ö —ç—Ç–æ–º—É –º–æ–º–µ–Ω—Ç—É `Bot` —É–∂–µ —Å–æ–∑–¥–∞–Ω.

**–ê–Ω–∞–ª–æ–≥–∏—è:**
- –ë–µ–∑ @Lazy: "–Ø –Ω–µ –ø–æ–π–¥—É –Ω–∞ –≤–µ—á–µ—Ä–∏–Ω–∫—É, –ø–æ–∫–∞ –ú–∞—à–∫–∞ –Ω–µ –ø—Ä–∏–¥—ë—Ç" + "–Ø –Ω–µ –ø–æ–π–¥—É, –ø–æ–∫–∞ –í–æ–≤–∫–∞ –Ω–µ –ø—Ä–∏–¥—ë—Ç" = –Ω–∏–∫—Ç–æ –Ω–µ –ø—Ä–∏—à—ë–ª.
- –° @Lazy: "–û–∫–µ–π, —è –ø—Ä–∏–¥—É, –∞ –ú–∞—à–∫—É –ø–æ–¥–æ–∂–¥—É –≤–Ω—É—Ç—Ä–∏" = –≤—Å–µ –ø—Ä–∏—à–ª–∏.

## registrationDataMap

**–ß—Ç–æ —ç—Ç–æ:** –•—Ä–∞–Ω–∏–ª–∏—â–µ —Å–æ—Å—Ç–æ—è–Ω–∏–π —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –≤—Å–µ—Ö —é–∑–µ—Ä–æ–≤.  
**–¢–∏–ø –∫–ª—é—á–∞:** `Long` ‚Äî —ç—Ç–æ `telegramId` —é–∑–µ—Ä–∞.  
**–¢–∏–ø –∑–Ω–∞—á–µ–Ω–∏—è:** `ShopRegistrationData` ‚Äî –¥–∞–Ω–Ω—ã–µ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ (—à–∞–≥ + –≤–≤–µ–¥—ë–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ).

**–í—Ä–µ–º—è –∂–∏–∑–Ω–∏ –¥–∞–Ω–Ω—ã—Ö:**
- –ü–æ—è–≤–ª—è—é—Ç—Å—è –ø—Ä–∏ `/register_shop`.
- –û–±–Ω–æ–≤–ª—è—é—Ç—Å—è –ø—Ä–∏ –∫–∞–∂–¥–æ–º —à–∞–≥–µ.
- –£–¥–∞–ª—è—é—Ç—Å—è –ø–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è (—É—Å–ø–µ—Ö –∏–ª–∏ –æ—à–∏–±–∫–∞).

**–í–∞–∂–Ω–æ:** –≠—Ç–æ **in-memory storage** ‚Äî —Ö—Ä–∞–Ω–∏—Ç—Å—è –≤ –æ–ø–µ—Ä–∞—Ç–∏–≤–∫–µ. –ï—Å–ª–∏ —Å–µ—Ä–≤–µ—Ä –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—Å—è ‚Äî –≤—Å–µ –Ω–µ–∑–∞–≤–µ—Ä—à—ë–Ω–Ω—ã–µ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –ø–æ—Ç–µ—Ä—è—é—Ç—Å—è. –î–ª—è MVP —ç—Ç–æ –æ–∫. –î–ª—è –ø—Ä–æ–¥–∞ –º–æ–∂–Ω–æ —Ö—Ä–∞–Ω–∏—Ç—å –≤ Redis.

---

# STARTREGISTRATION

```java
public void startRegistration(Update update) {
    Long chatId = update.getMessage().getChatId();
    Long telegramId = update.getMessage().getFrom().getId();

    log.info("–ù–∞—á–∞–ª–æ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –º–∞–≥–∞–∑–∏–Ω–∞: telegramId={}", telegramId);

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ—Ç –ª–∏ —É–∂–µ –º–∞–≥–∞–∑–∏–Ω–∞ —É —ç—Ç–æ–≥–æ —é–∑–µ—Ä–∞
    if (shopService.findByUserTelegramId(telegramId).isPresent()) {
        sendMessage(chatId, "‚ùå –£ —Ç–µ–±—è —É–∂–µ –µ—Å—Ç—å –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –º–∞–≥–∞–∑–∏–Ω!");
        return;
    }

    // –°–æ–∑–¥–∞—ë–º –¥–∞–Ω–Ω—ã–µ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –∏ —Å—Ç–∞–≤–∏–º –ø–µ—Ä–≤—ã–π —à–∞–≥
    ShopRegistrationData data = new ShopRegistrationData();
    data.setState(RegistrationState.WAITING_SHOP_NAME);
    registrationDataMap.put(telegramId, data);

    sendMessage(chatId, "üè™ *–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –º–∞–≥–∞–∑–∏–Ω–∞*\n\n" +
            "–®–∞–≥ 1 –∏–∑ 3\n" +
            "–í–≤–µ–¥–∏ *–Ω–∞–∑–≤–∞–Ω–∏–µ* —Ç–≤–æ–µ–≥–æ –º–∞–≥–∞–∑–∏–Ω–∞:");
}
```

## –ü–æ—Å—Ç—Ä–æ—á–Ω—ã–π —Ä–∞–∑–±–æ—Ä

### –ü–æ–ª—É—á–µ–Ω–∏–µ ID

```java
Long chatId = update.getMessage().getChatId();
Long telegramId = update.getMessage().getFrom().getId();
```

**chatId** ‚Äî –∫—É–¥–∞ –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å –æ—Ç–≤–µ—Ç (ID —á–∞—Ç–∞).  
**telegramId** ‚Äî –∫—Ç–æ –Ω–∞–ø–∏—Å–∞–ª (ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è).

–í –ª–∏—á–∫–µ `chatId == telegramId`. –í –≥—Ä—É–ø–ø–æ–≤–æ–º —á–∞—Ç–µ ‚Äî —Ä–∞–∑–Ω—ã–µ.

### –ü—Ä–æ–≤–µ—Ä–∫–∞ "—É–∂–µ –µ—Å—Ç—å –º–∞–≥–∞–∑–∏–Ω"

```java
if (shopService.findByUserTelegramId(telegramId).isPresent()) {
    sendMessage(chatId, "‚ùå –£ —Ç–µ–±—è —É–∂–µ –µ—Å—Ç—å –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –º–∞–≥–∞–∑–∏–Ω!");
    return;
}
```

**`.isPresent()`** ‚Äî –º–µ—Ç–æ–¥ Optional, –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç `true` –µ—Å–ª–∏ –∑–Ω–∞—á–µ–Ω–∏–µ –µ—Å—Ç—å.

–ï—Å–ª–∏ —é–∑–µ—Ä —É–∂–µ –∑–∞—Ä–µ–≥–∞–ª –º–∞–≥–∞–∑–∏–Ω ‚Äî –Ω–∞—Ö—É–π –µ–≥–æ, –ø—É—Å—Ç—å –Ω–µ —Å–æ–∑–¥–∞—ë—Ç –≤—Ç–æ—Ä–æ–π.

### –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö

```java
ShopRegistrationData data = new ShopRegistrationData();
data.setState(RegistrationState.WAITING_SHOP_NAME);
registrationDataMap.put(telegramId, data);
```

1. –°–æ–∑–¥–∞—ë–º –æ–±—ä–µ–∫—Ç –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö.
2. –°—Ç–∞–≤–∏–º –ø–µ—Ä–≤—ã–π —à–∞–≥ ‚Äî "–∂–¥—ë–º –Ω–∞–∑–≤–∞–Ω–∏–µ".
3. –ö–ª–∞–¥—ë–º –≤ Map –ø–æ –∫–ª—é—á—É `telegramId`.

–¢–µ–ø–µ—Ä—å –∫–æ–≥–¥–∞ —é–∑–µ—Ä –Ω–∞–ø–∏—à–µ—Ç —á—Ç–æ-—Ç–æ ‚Äî –º—ã –Ω–∞–π–¥—ë–º –µ–≥–æ –¥–∞–Ω–Ω—ã–µ –∏ —É–∑–Ω–∞–µ–º, —á—Ç–æ –æ–Ω –Ω–∞ —à–∞–≥–µ "–≤–≤–æ–¥ –Ω–∞–∑–≤–∞–Ω–∏—è".

### –û—Ç–ø—Ä–∞–≤–∫–∞ –ø–µ—Ä–≤–æ–≥–æ –≤–æ–ø—Ä–æ—Å–∞

```java
sendMessage(chatId, "üè™ *–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –º–∞–≥–∞–∑–∏–Ω–∞*\n\n" +
        "–®–∞–≥ 1 –∏–∑ 3\n" +
        "–í–≤–µ–¥–∏ *–Ω–∞–∑–≤–∞–Ω–∏–µ* —Ç–≤–æ–µ–≥–æ –º–∞–≥–∞–∑–∏–Ω–∞:");
```

**`\n\n`** ‚Äî –¥–≤–∞ –ø–µ—Ä–µ–Ω–æ—Å–∞ —Å—Ç—Ä–æ–∫–∏ (–ø—É—Å—Ç–∞—è —Å—Ç—Ä–æ–∫–∞ –º–µ–∂–¥—É –±–ª–æ–∫–∞–º–∏).  
**`*—Ç–µ–∫—Å—Ç*`** ‚Äî –∂–∏—Ä–Ω—ã–π —Ç–µ–∫—Å—Ç –≤ Markdown (–ø–æ—Ç–æ–º—É —á—Ç–æ `setParseMode("Markdown")`).

---

# HANDLEMESSAGE

```java
public boolean handleMessage(Update update) {
    Long telegramId = update.getMessage().getFrom().getId();
    Long chatId = update.getMessage().getChatId();
    String text = update.getMessage().getText();

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —é–∑–µ—Ä –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
    ShopRegistrationData data = registrationDataMap.get(telegramId);
    if (data == null || data.getState() == RegistrationState.NONE) {
        return false; // –Æ–∑–µ—Ä –Ω–µ –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
    }

    log.debug("–û–±—Ä–∞–±–æ—Ç–∫–∞ —à–∞–≥–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏: telegramId={}, state={}, text={}",
            telegramId, data.getState(), text);

    // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–µ–∫—É—â–µ–≥–æ —à–∞–≥–∞
    switch (data.getState()) {
        case WAITING_SHOP_NAME:
            handleShopName(chatId, telegramId, text, data);
            break;
        case WAITING_PICKUP_ADDRESS:
            handlePickupAddress(chatId, telegramId, text, data);
            break;
        case WAITING_PHONE:
            handlePhone(chatId, telegramId, text, data);
            break;
        default:
            return false;
    }

    return true; // –°–æ–æ–±—â–µ–Ω–∏–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–æ
}
```

## –ß—Ç–æ —ç—Ç–æ –∑–∞ –º–µ—Ç–æ–¥

–≠—Ç–æ—Ç –º–µ—Ç–æ–¥ **—Ä–æ—É—Ç–µ—Ä** ‚Äî –æ–Ω –ø–æ–ª—É—á–∞–µ—Ç –ª—é–±–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –∏ —Ä–µ—à–∞–µ—Ç:
1. –Æ–∑–µ—Ä –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏? –ï—Å–ª–∏ –Ω–µ—Ç ‚Üí –≤–µ—Ä–Ω—É—Ç—å `false` (–ø—É—Å—Ç—å –¥—Ä—É–≥–æ–π —Ö–µ–Ω–¥–ª–µ—Ä –æ–±—Ä–∞–±–æ—Ç–∞–µ—Ç).
2. –ù–∞ –∫–∞–∫–æ–º —à–∞–≥–µ? ‚Üí –í—ã–∑–≤–∞—Ç—å —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫.

## –í–æ–∑–≤—Ä–∞—â–∞–µ–º–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ boolean

```java
public boolean handleMessage(Update update)
```

**true** ‚Äî —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–æ —ç—Ç–∏–º —Ö–µ–Ω–¥–ª–µ—Ä–æ–º.  
**false** ‚Äî –Ω–µ –Ω–∞—à –∫–ª–∏–µ–Ω—Ç, –ø—É—Å—Ç—å –¥—Ä—É–≥–∏–µ —Ä–∞–∑–±–∏—Ä–∞—é—Ç—Å—è.

–≠—Ç–æ –Ω—É–∂–Ω–æ –¥–ª—è **Bot.java** ‚Äî —Ç–∞–º —Ü–µ–ø–æ—á–∫–∞ —Ö–µ–Ω–¥–ª–µ—Ä–æ–≤:
```java
if (shopRegistrationHandler.handleMessage(update)) {
    return; // –û–±—Ä–∞–±–æ—Ç–∞–Ω–æ
}
// –ò–Ω–∞—á–µ –ø—Ä–æ–≤–µ—Ä—è–µ–º –¥—Ä—É–≥–∏–µ –∫–æ–º–∞–Ω–¥—ã...
```

## switch –ø–æ —Å–æ—Å—Ç–æ—è–Ω–∏—é

```java
switch (data.getState()) {
    case WAITING_SHOP_NAME:
        handleShopName(chatId, telegramId, text, data);
        break;
    // ...
}
```

**switch** ‚Äî –≤—ã–±–æ—Ä –≤–µ—Ç–∫–∏ –ø–æ –∑–Ω–∞—á–µ–Ω–∏—é.

–ü–æ—á–µ–º—É `break` –ø–æ—Å–ª–µ –∫–∞–∂–¥–æ–≥–æ case? –ë–µ–∑ –Ω–µ–≥–æ Java –ø—Ä–æ–≤–∞–ª–∏–≤–∞–µ—Ç—Å—è –≤ —Å–ª–µ–¥—É—é—â–∏–π case (fall-through). –≠—Ç–æ –∏–Ω–æ–≥–¥–∞ –ø–æ–ª–µ–∑–Ω–æ, –Ω–æ –æ–±—ã—á–Ω–æ ‚Äî –±–∞–≥.

**–ê–Ω–∞–ª–æ–≥–∏—è:**
```
switch (—ç—Ç–∞–∂) {
    case 1: –ø–æ—Å–µ—Ç–∏—Ç—å_–±—É—Ö–≥–∞–ª—Ç–µ—Ä–∏—é(); break;
    case 2: –ø–æ—Å–µ—Ç–∏—Ç—å_HR(); break;
    case 3: –ø–æ—Å–µ—Ç–∏—Ç—å_CEO(); break;
}
```

–ë–µ–∑ `break`:
```
case 1: –ø–æ—Å–µ—Ç–∏—Ç—å_–±—É—Ö–≥–∞–ª—Ç–µ—Ä–∏—é(); // –∏ –ø–∞–¥–∞–µ—Ç –≤–Ω–∏–∑
case 2: –ø–æ—Å–µ—Ç–∏—Ç—å_HR();         // –∏ —ç—Ç–æ —Ç–æ–∂–µ –≤—ã–ø–æ–ª–Ω–∏—Ç—Å—è!
case 3: –ø–æ—Å–µ—Ç–∏—Ç—å_CEO();        // –∏ —ç—Ç–æ!
```

---

# –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò –®–ê–ì–û–í

## handleShopName

```java
private void handleShopName(Long chatId, Long telegramId, String text, ShopRegistrationData data) {
    // –í–∞–ª–∏–¥–∞—Ü–∏—è
    if (text.length() < 2) {
        sendMessage(chatId, "‚ùå –ù–∞–∑–≤–∞–Ω–∏–µ —Å–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–æ–µ. –í–≤–µ–¥–∏ –º–∏–Ω–∏–º—É–º 2 —Å–∏–º–≤–æ–ª–∞:");
        return;
    }
    if (text.length() > 255) {
        sendMessage(chatId, "‚ùå –ù–∞–∑–≤–∞–Ω–∏–µ —Å–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω–æ–µ. –ú–∞–∫—Å–∏–º—É–º 255 —Å–∏–º–≤–æ–ª–æ–≤:");
        return;
    }

    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏ –ø–µ—Ä–µ—Ö–æ–¥–∏–º –∫ —Å–ª–µ–¥—É—é—â–µ–º—É —à–∞–≥—É
    data.setShopName(text);
    data.setState(RegistrationState.WAITING_PICKUP_ADDRESS);

    sendMessage(chatId, "‚úÖ –ù–∞–∑–≤–∞–Ω–∏–µ: *" + text + "*\n\n" +
            "–®–∞–≥ 2 –∏–∑ 3\n" +
            "–í–≤–µ–¥–∏ *–∞–¥—Ä–µ—Å –∑–∞–±–æ—Ä–∞* –∑–∞–∫–∞–∑–æ–≤\n" +
            "(–æ—Ç–∫—É–¥–∞ –∫—É—Ä—å–µ—Ä –±—É–¥–µ—Ç –∑–∞–±–∏—Ä–∞—Ç—å —Ü–≤–µ—Ç—ã):");
}
```

### –ü–∞—Ç—Ç–µ—Ä–Ω: –í–∞–ª–∏–¥–∞—Ü–∏—è ‚Üí –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ ‚Üí –ü–µ—Ä–µ—Ö–æ–¥

1. **–í–∞–ª–∏–¥–∞—Ü–∏—è** ‚Äî –ø—Ä–æ–≤–µ—Ä—è–µ–º –≤—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ. –ï—Å–ª–∏ —Ö—É–π–Ω—è ‚Äî –æ—Å—Ç–∞—ë–º—Å—è –Ω–∞ —ç—Ç–æ–º —à–∞–≥–µ.
2. **–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ** ‚Äî –∑–∞–ø–∏—Å—ã–≤–∞–µ–º –≤–∞–ª–∏–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –≤ `data`.
3. **–ü–µ—Ä–µ—Ö–æ–¥** ‚Äî –º–µ–Ω—è–µ–º `state` –Ω–∞ —Å–ª–µ–¥—É—é—â–∏–π —à–∞–≥.
4. **–ü—Ä–æ–º–ø—Ç** ‚Äî —Å–ø—Ä–∞—à–∏–≤–∞–µ–º —Å–ª–µ–¥—É—é—â–∏–π –≤–æ–ø—Ä–æ—Å.

### –ü–æ—á–µ–º—É return –ø–æ—Å–ª–µ –æ—à–∏–±–∫–∏ –≤–∞–ª–∏–¥–∞—Ü–∏–∏

```java
if (text.length() < 2) {
    sendMessage(chatId, "‚ùå ...");
    return; // –í–ê–ñ–ù–û!
}
```

–ë–µ–∑ `return` –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—Å—è, –∏ –º—ã —Å–æ—Ö—Ä–∞–Ω–∏–º –Ω–µ–≤–∞–ª–∏–¥–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ. `return` –ø—Ä–µ—Ä—ã–≤–∞–µ—Ç –º–µ—Ç–æ–¥ ‚Äî —é–∑–µ—Ä –æ—Å—Ç–∞—ë—Ç—Å—è –Ω–∞ —Ç–æ–º –∂–µ —à–∞–≥–µ –∏ –º–æ–∂–µ—Ç –≤–≤–µ—Å—Ç–∏ –∑–∞–Ω–æ–≤–æ.

## handlePickupAddress

–ê–Ω–∞–ª–æ–≥–∏—á–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞. –í–∞–ª–∏–¥–∞—Ü–∏—è ‚Üí –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ ‚Üí –ü–µ—Ä–µ—Ö–æ–¥.

## handlePhone

```java
private void handlePhone(Long chatId, Long telegramId, String text, ShopRegistrationData data) {
    String phone = null;

    if (!text.equals("/skip")) {
        if (text.length() < 5 || text.length() > 50) {
            sendMessage(chatId, "‚ùå –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π —Ç–µ–ª–µ—Ñ–æ–Ω...");
            return;
        }
        phone = text;
    }

    data.setPhone(phone);

    try {
        Shop shop = shopService.createShopForUser(
                telegramId,
                data.getShopName(),
                data.getPickupAddress(),
                data.getPhone()
        );

        registrationDataMap.remove(telegramId);

        sendMessage(chatId, "üéâ *–ú–∞–≥–∞–∑–∏–Ω —É—Å–ø–µ—à–Ω–æ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω!*...");

    } catch (Exception e) {
        log.error("–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –º–∞–≥–∞–∑–∏–Ω–∞: telegramId={}", telegramId, e);
        registrationDataMap.remove(telegramId);
        sendMessage(chatId, "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –º–∞–≥–∞–∑–∏–Ω–∞: " + e.getMessage() + "...");
    }
}
```

### –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏

**1. /skip ‚Äî –ø—Ä–æ–ø—É—Å–∫ —à–∞–≥–∞**

```java
if (!text.equals("/skip")) {
    // –≤–∞–ª–∏–¥–∞—Ü–∏—è –∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ç–µ–ª–µ—Ñ–æ–Ω–∞
    phone = text;
}
// –µ—Å–ª–∏ /skip ‚Äî phone –æ—Å—Ç–∞–Ω–µ—Ç—Å—è null
```

–¢–µ–ª–µ—Ñ–æ–Ω –Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–π. –Æ–∑–µ—Ä –º–æ–∂–µ—Ç –Ω–∞–ø–∏—Å–∞—Ç—å `/skip` ‚Äî —Ç–æ–≥–¥–∞ `phone = null`.

**2. try-catch –≤–æ–∫—Ä—É–≥ —Å–æ–∑–¥–∞–Ω–∏—è**

```java
try {
    Shop shop = shopService.createShopForUser(...);
    // —É—Å–ø–µ—Ö
} catch (Exception e) {
    // –ø—Ä–æ–≤–∞–ª
}
```

–ß—Ç–æ –º–æ–∂–µ—Ç –ø–æ–π—Ç–∏ –Ω–µ —Ç–∞–∫ –≤ `createShopForUser`:
- –Æ–∑–µ—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω (–∫—Ç–æ-—Ç–æ —É–¥–∞–ª–∏–ª –∏–∑ –ë–î).
- –ú–∞–≥–∞–∑–∏–Ω —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç (race condition ‚Äî –¥–≤–∞ –∑–∞–ø—Ä–æ—Å–∞ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ).
- –ë–î –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞.

–õ–æ–≤–∏–º **–ª—é–±–æ–µ** –∏—Å–∫–ª—é—á–µ–Ω–∏–µ –∏ —Å–æ–æ–±—â–∞–µ–º —é–∑–µ—Ä—É –æ–± –æ—à–∏–±–∫–µ.

**3. –û—á–∏—Å—Ç–∫–∞ –¥–∞–Ω–Ω—ã—Ö –≤ –æ–±–æ–∏—Ö —Å–ª—É—á–∞—è—Ö**

```java
registrationDataMap.remove(telegramId); // –∏ –ø—Ä–∏ —É—Å–ø–µ—Ö–µ
registrationDataMap.remove(telegramId); // –∏ –ø—Ä–∏ –æ—à–∏–±–∫–µ
```

–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞ (—É—Å–ø–µ—à–Ω–æ –∏–ª–∏ –Ω–µ—Ç) ‚Äî —É–¥–∞–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ –ø–∞–º—è—Ç–∏. –Æ–∑–µ—Ä –º–æ–∂–µ—Ç –Ω–∞—á–∞—Ç—å –∑–∞–Ω–æ–≤–æ.

---

# –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –ú–ï–¢–û–î–´

## isUserInRegistration

```java
public boolean isUserInRegistration(Long telegramId) {
    ShopRegistrationData data = registrationDataMap.get(telegramId);
    return data != null && data.getState() != RegistrationState.NONE;
}
```

–ü—Ä–æ–≤–µ—Ä—è–µ—Ç, –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –ª–∏ —é–∑–µ—Ä –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏.  
–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ `Bot.java` –¥–ª—è –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏–∏.

**–õ–æ–≥–∏–∫–∞:**
- `data == null` ‚Üí —é–∑–µ—Ä –Ω–∏–∫–æ–≥–¥–∞ –Ω–µ –Ω–∞—á–∏–Ω–∞–ª —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é ‚Üí `false`.
- `data.getState() == NONE` ‚Üí —é–∑–µ—Ä –∑–∞–≤–µ—Ä—à–∏–ª —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é ‚Üí `false`.
- –ò–Ω–∞—á–µ ‚Üí —é–∑–µ—Ä –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ ‚Üí `true`.

## cancelRegistration

```java
public void cancelRegistration(Long telegramId, Long chatId) {
    registrationDataMap.remove(telegramId);
    sendMessage(chatId, "‚ùå –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –æ—Ç–º–µ–Ω–µ–Ω–∞.");
}
```

–û—Ç–º–µ–Ω–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ (–µ—Å–ª–∏ —é–∑–µ—Ä –ø–µ—Ä–µ–¥—É–º–∞–ª). –ú–æ–∂–Ω–æ –≤—ã–∑—ã–≤–∞—Ç—å –ø–æ –∫–æ–º–∞–Ω–¥–µ `/cancel`.

## sendMessage

```java
private void sendMessage(Long chatId, String text) {
    SendMessage message = new SendMessage();
    message.setChatId(chatId.toString());
    message.setText(text);
    message.setParseMode("Markdown");

    try {
        bot.execute(message);
    } catch (TelegramApiException e) {
        log.error("–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è: chatId={}", chatId, e);
    }
}
```

**–ü—Ä–∏–≤–∞—Ç–Ω—ã–π** –≤—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–π –º–µ—Ç–æ–¥ ‚Äî –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–¥–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π.

**`setParseMode("Markdown")`** ‚Äî –≤–∫–ª—é—á–∞–µ—Ç —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ:
- `*–∂–∏—Ä–Ω—ã–π*` ‚Üí **–∂–∏—Ä–Ω—ã–π**
- `_–∫—É—Ä—Å–∏–≤_` ‚Üí *–∫—É—Ä—Å–∏–≤*
- `` `–∫–æ–¥` `` ‚Üí `–∫–æ–¥`

---

# –ü–†–ê–ö–¢–ò–ö–ê

## –ó–∞–¥–∞–Ω–∏–µ 1: –î–æ–±–∞–≤—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ "–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ"

–°–µ–π—á–∞—Å –ø–æ—Å–ª–µ –≤–≤–æ–¥–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –º–∞–≥–∞–∑–∏–Ω —Å—Ä–∞–∑—É —Å–æ–∑–¥–∞—ë—Ç—Å—è. –î–æ–±–∞–≤—å –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã–π —à–∞–≥:

```
–ë–æ—Ç: –ü—Ä–æ–≤–µ—Ä—å –¥–∞–Ω–Ω—ã–µ:
     ‚Ä¢ –ù–∞–∑–≤–∞–Ω–∏–µ: –¶–≤–µ—Ç—ã –Ω–∞ –õ–µ–Ω–∏–Ω–∞
     ‚Ä¢ –ê–¥—Ä–µ—Å: —É–ª. –õ–µ–Ω–∏–Ω–∞, 10
     ‚Ä¢ –¢–µ–ª–µ—Ñ–æ–Ω: +79991234567
     
     –í—Å—ë –≤–µ—Ä–Ω–æ? (–¥–∞/–Ω–µ—Ç)
     
–Æ–∑–µ—Ä: –¥–∞
–ë–æ—Ç: üéâ –ú–∞–≥–∞–∑–∏–Ω —Å–æ–∑–¥–∞–Ω!
```

**–ß—Ç–æ –Ω—É–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å:**
1. –î–æ–±–∞–≤—å `WAITING_CONFIRMATION` –≤ `RegistrationState`.
2. –í `handlePhone` ‚Äî –≤–º–µ—Å—Ç–æ —Å–æ–∑–¥–∞–Ω–∏—è –º–∞–≥–∞–∑–∏–Ω–∞ –ø–µ—Ä–µ—Ö–æ–¥–∏ –Ω–∞ `WAITING_CONFIRMATION`.
3. –°–æ–∑–¥–∞–π –º–µ—Ç–æ–¥ `handleConfirmation`:
   - –ï—Å–ª–∏ "–¥–∞" ‚Üí —Å–æ–∑–¥–∞—Ç—å –º–∞–≥–∞–∑–∏–Ω.
   - –ï—Å–ª–∏ "–Ω–µ—Ç" ‚Üí –≤–µ—Ä–Ω—É—Ç—å—Å—è –∫ –Ω–∞—á–∞–ª—É –∏–ª–∏ –æ—Ç–º–µ–Ω–∏—Ç—å.

---

## –ó–∞–¥–∞–Ω–∏–µ 2: –î–æ–±–∞–≤—å –∫–æ–º–∞–Ω–¥—É /cancel

–Æ–∑–µ—Ä –¥–æ–ª–∂–µ–Ω –∏–º–µ—Ç—å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –æ—Ç–º–µ–Ω–∏—Ç—å —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é –Ω–∞ –ª—é–±–æ–º —à–∞–≥–µ.

**–ß—Ç–æ –Ω—É–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å:**
1. –í `handleMessage` –ø–µ—Ä–µ–¥ `switch` –¥–æ–±–∞–≤—å –ø—Ä–æ–≤–µ—Ä–∫—É:
   ```java
   if (text.equals("/cancel")) {
       cancelRegistration(telegramId, chatId);
       return true;
   }
   ```
2. –í `Bot.java` –¥–æ–±–∞–≤—å –º–∞—Ä—à—Ä—É—Ç –¥–ª—è `/cancel`.

---

## –ó–∞–¥–∞–Ω–∏–µ 3: –£–ª—É—á—à–∏ –≤–∞–ª–∏–¥–∞—Ü–∏—é —Ç–µ–ª–µ—Ñ–æ–Ω–∞

–°–µ–π—á–∞—Å –≤–∞–ª–∏–¥–∞—Ü–∏—è —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –ø—Ä–∏–º–∏—Ç–∏–≤–Ω–∞—è (—Ç–æ–ª—å–∫–æ –¥–ª–∏–Ω–∞). –°–¥–µ–ª–∞–π –Ω–æ—Ä–º–∞–ª—å–Ω—É—é:

```java
// –î–æ–ª–∂–µ–Ω –Ω–∞—á–∏–Ω–∞—Ç—å—Å—è —Å + –∏–ª–∏ 8
// –î–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å —Ç–æ–ª—å–∫–æ —Ü–∏—Ñ—Ä—ã (–∏ –º–æ–∂–µ—Ç –±—ã—Ç—å -)
// –ü—Ä–∏–º–µ—Ä: +79991234567, 89991234567, +7-999-123-45-67
```

**–ü–æ–¥—Å–∫–∞–∑–∫–∞:** –ò—Å–ø–æ–ª—å–∑—É–π —Ä–µ–≥—É–ª—è—Ä–Ω–æ–µ –≤—ã—Ä–∞–∂–µ–Ω–∏–µ:
```java
String phonePattern = "^[+]?[0-9\\-]{10,15}$";
if (!text.matches(phonePattern)) {
    sendMessage(chatId, "‚ùå –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç —Ç–µ–ª–µ—Ñ–æ–Ω–∞...");
    return;
}
```

---

## –ó–∞–¥–∞–Ω–∏–µ 4: –î–æ–±–∞–≤—å –∫–Ω–æ–ø–∫—É "–ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å"

–í–º–µ—Å—Ç–æ —Ç–µ–∫—Å—Ç–æ–≤–æ–π –∫–æ–º–∞–Ω–¥—ã `/skip` —Å–¥–µ–ª–∞–π InlineKeyboard —Å –∫–Ω–æ–ø–∫–æ–π "–ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å".

**–ß—Ç–æ –Ω—É–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å:**
1. –í `handlePickupAddress` –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –≤–æ–ø—Ä–æ—Å–∞ –ø—Ä–æ —Ç–µ–ª–µ—Ñ–æ–Ω –¥–æ–±–∞–≤—å –∫–Ω–æ–ø–∫—É.
2. –í `CallbackQueryHandler` –æ–±—Ä–∞–±–æ—Ç–∞–π callback `skip_phone`.
3. –í—ã–∑–æ–≤–∏ –∏–∑ –Ω–µ–≥–æ –ª–æ–≥–∏–∫—É –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏.

---

## –ó–∞–¥–∞–Ω–∏–µ 5: –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö

–î–æ–±–∞–≤—å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –≤–≤–µ–¥—ë–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ. –ö–æ–≥–¥–∞ —é–∑–µ—Ä –Ω–∞ —à–∞–≥–µ 3 (—Ç–µ–ª–µ—Ñ–æ–Ω), –æ–Ω –º–æ–∂–µ—Ç –Ω–∞–ø–∏—Å–∞—Ç—å `/edit_name` —á—Ç–æ–±—ã –≤–µ—Ä–Ω—É—Ç—å—Å—è –∫ —à–∞–≥—É 1.

**–ß—Ç–æ –Ω—É–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å:**
1. –í `handleMessage` –¥–æ–±–∞–≤—å –ø—Ä–æ–≤–µ—Ä–∫—É –Ω–∞ `/edit_name`, `/edit_address`.
2. –ü—Ä–∏ `/edit_name`:
   - `data.setState(RegistrationState.WAITING_SHOP_NAME)`
   - `data.setShopName(null)` ‚Äî —Å–±—Ä–∞—Å—ã–≤–∞–µ–º —Å—Ç–∞—Ä–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
   - –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤–æ–ø—Ä–æ—Å –∑–∞–Ω–æ–≤–æ.

---

# –ò–¢–û–ì–û

**–ß—Ç–æ –º—ã –∏–∑—É—á–∏–ª–∏:**
- **State Machine** ‚Äî –∫–æ–Ω–µ—á–Ω—ã–π –∞–≤—Ç–æ–º–∞—Ç –¥–ª—è –ø–æ—à–∞–≥–æ–≤—ã—Ö –¥–∏–∞–ª–æ–≥–æ–≤.
- **ConcurrentHashMap** ‚Äî –ø–æ—Ç–æ–∫–æ–±–µ–∑–æ–ø–∞—Å–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ.
- **–ü–∞—Ç—Ç–µ—Ä–Ω "–í–∞–ª–∏–¥–∞—Ü–∏—è ‚Üí –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ ‚Üí –ü–µ—Ä–µ—Ö–æ–¥"**.
- **@Lazy** ‚Äî —Ä–µ—à–µ–Ω–∏–µ circular dependency.
- **try-catch** ‚Äî –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫.
- **–ü—Ä–∏–≤–∞—Ç–Ω—ã–µ –≤—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ –º–µ—Ç–æ–¥—ã** ‚Äî DRY (Don't Repeat Yourself).

**–°–ª–µ–¥—É—é—â–∏–π —à–∞–≥:** –ü–æ–¥–∫–ª—é—á–∏—Ç—å —Ö–µ–Ω–¥–ª–µ—Ä –∫ –±–æ—Ç—É (Bot.java) –∏ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å!
