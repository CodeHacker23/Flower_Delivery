# –¢–û–¢–ê–õ–¨–ù–´–ô –†–ê–ó–ë–û–†: StartCommandHandler.java
## –ß—Ç–æ –Ω–∞ —Å–∞–º–æ–º –¥–µ–ª–µ –¥–µ–ª–∞–µ—Ç `/start`

> **–£—Ä–æ–≤–µ–Ω—å**: "–ñ–º—É /start, –±–æ—Ç —á—Ç–æ-—Ç–æ –æ—Ä—ë—Ç ‚Äî –•–û–ß–£ –ó–ù–ê–¢–¨ –ö–¢–û"  
> **–¶–µ–ª—å**: –ü–æ–Ω—è—Ç—å, –∫–∞–∫ –±–æ—Ç:
> - —Å–æ–∑–¥–∞—ë—Ç `User` –≤ –ë–î,
> - —Ä–µ—à–∞–µ—Ç, —á—Ç–æ –ø–æ–∫–∞–∑–∞—Ç—å (–≤—ã–±–æ—Ä —Ä–æ–ª–∏ / –º–µ–Ω—é –º–∞–≥–∞–∑–∏–Ω–∞),
> - –æ—Ç–∫—É–¥–∞ –±–µ—Ä—É—Ç—Å—è –≤—Å–µ —ç—Ç–∏ `update`, `message`, `chatId`, `from`, –∏ —Ç.–¥.  
> **–°—Ç–∏–ª—å**: –∫–∞–∫ –±—É–¥—Ç–æ —Ç—ã –≤ 3 –Ω–æ—á–∏ –∑–∞—à—ë–ª –≤ –∫–æ–¥ –∏ –ø—ã—Ç–∞–µ—à—å—Å—è –≤—Å–ø–æ–º–Ω–∏—Ç—å, –∫–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç —Ç–≤–æ–π –∂–µ –±–æ—Ç

---

## –ì–¥–µ —ç—Ç–æ—Ç —Ö–µ–Ω–¥–ª–µ—Ä –≤ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–µ

–°—Ö–µ–º–∞ —Å–æ–±—ã—Ç–∏–π –ø—Ä–∏ `/start`:

```text
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤ Telegram –ø–∏—à–µ—Ç: /start
        ‚Üì
Telegram —à–ª—ë—Ç Update –±–æ—Ç—É
        ‚Üì
Bot.onUpdateReceived(update)
        ‚Üì
StartCommandHandler.handle(update)
        ‚Üì
UserService.registerUser(...)
ShopService.findByUserTelegramId(...)
        ‚Üì
–ª–∏–±–æ –≤—ã–±–æ—Ä —Ä–æ–ª–∏, –ª–∏–±–æ –º–µ–Ω—é –º–∞–≥–∞–∑–∏–Ω–∞
```

`StartCommandHandler` ‚Äî —ç—Ç–æ —Ç–æ—á–∫–∞ –≤—Ö–æ–¥–∞:

- –∏–º–µ–Ω–Ω–æ –æ–Ω:
  - –ø—Ä–æ–≤–µ—Ä—è–µ—Ç, —á—Ç–æ —ç—Ç–æ –≤–æ–æ–±—â–µ `/start`,
  - —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ—Ç —é–∑–µ—Ä–∞ (–µ—Å–ª–∏ –ø–µ—Ä–≤—ã–π —Ä–∞–∑),
  - —Ä–µ—à–∞–µ—Ç, —á—Ç–æ –ø–æ–∫–∞–∑–∞—Ç—å:
    - –≤—ã–±–æ—Ä —Ä–æ–ª–∏,
    - –∏–ª–∏ —Å—Ä–∞–∑—É –º–µ–Ω—é –º–∞–≥–∞–∑–∏–Ω–∞, –µ—Å–ª–∏ —É–∂–µ –≤—Å—ë –µ—Å—Ç—å.

---

## –ü–æ–ª–Ω—ã–π –∫–æ–¥, —á—Ç–æ–±—ã –≤–∏–¥–µ—Ç—å –∫–∞—Ä—Ç–∏–Ω—É

```java
package org.example.flower_delivery.handler;

import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.example.flower_delivery.Bot;
import org.example.flower_delivery.model.Shop;
import org.example.flower_delivery.service.ShopService;
import org.example.flower_delivery.service.UserService;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.context.annotation.Lazy;
import org.springframework.stereotype.Component;
import org.telegram.telegrambots.meta.api.methods.send.SendMessage;
import org.telegram.telegrambots.meta.api.objects.Message;
import org.telegram.telegrambots.meta.api.objects.Update;
import org.telegram.telegrambots.meta.api.objects.replykeyboard.InlineKeyboardMarkup;
import org.telegram.telegrambots.meta.api.objects.replykeyboard.buttons.InlineKeyboardButton;
import org.telegram.telegrambots.meta.exceptions.TelegramApiException;

import java.util.ArrayList;
import java.util.List;

@Slf4j
@Component
@RequiredArgsConstructor
public class StartCommandHandler {
    // Spring –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –Ω–∞–π–¥–µ—Ç UserService –∏ –ø–æ–¥—Å—Ç–∞–≤–∏—Ç —Å—é–¥–∞ (Dependency Injection)
    private final UserService userService;
    private final ShopService shopService;

    // Spring –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –Ω–∞–π–¥–µ—Ç Bot –∏ –ø–æ–¥—Å—Ç–∞–≤–∏—Ç —Å—é–¥–∞ (Dependency Injection)
    // @Lazy - —Å–æ–∑–¥–∞—ë—Ç –ø—Ä–æ–∫—Å–∏ –¥–ª—è Bot, —Ä–∞–∑—Ä—ã–≤–∞—è —Ü–∏–∫–ª–∏—á–µ—Å–∫—É—é –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å:
    // Bot ‚Üí StartCommandHandler ‚Üí Bot (–±–µ–∑ @Lazy –±—ã–ª –±—ã —Ü–∏–∫–ª!)
    // @Autowired –Ω–∞ –ø–æ–ª–µ (–Ω–µ —á–µ—Ä–µ–∑ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä, –ø–æ—Ç–æ–º—É —á—Ç–æ @Lazy –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç —Å final –ø–æ–ª—è–º–∏ –≤ @RequiredArgsConstructor)
    @Autowired
    @Lazy
    private Bot bot;

    // ...
}
```

–ü–æ–∫–∞ —Å–æ—Å—Ä–µ–¥–æ—Ç–æ—á–∏–º—Å—è –Ω–∞ –º–µ—Ç–æ–¥–µ `handle`, –∞ –ø–æ—Ç–æ–º –Ω–∞ –≤—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã—Ö.

---

# 1. –ê–Ω–Ω–æ—Ç–∞—Ü–∏–∏ –∏ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏

### –ü–∞–∫–µ—Ç –∏ –∏–º–ø–æ—Ä—Ç—ã

```java
package org.example.flower_delivery.handler;
```

- –ú—ã –≤ –ø–∞–∫–µ—Ç–µ `handler` ‚Äî —Ç—É—Ç –∂–∏–≤—É—Ç –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ Telegram‚Äë—Å–æ–±—ã—Ç–∏–π.

–ò–º–ø–æ—Ä—Ç—ã –∏–∑ `org.telegram.telegrambots.*`:

- `Update` ‚Äî –∞–ø–¥–µ–π—Ç –æ—Ç Telegram (—Å–æ–±—ã—Ç–∏–µ).
- `Message` ‚Äî —Å–æ–æ–±—â–µ–Ω–∏–µ –≤–Ω—É—Ç—Ä–∏ –∞–ø–¥–µ–π—Ç–∞.
- `SendMessage` ‚Äî –∫–æ–º–∞–Ω–¥–∞ "–æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Ç–µ–∫—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ".
- `InlineKeyboardMarkup`, `InlineKeyboardButton` ‚Äî inline‚Äë–∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞ –ø–æ–¥ —Å–æ–æ–±—â–µ–Ω–∏–µ–º.
- `TelegramApiException` ‚Äî –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—â–µ–Ω–∏–∏ —Å Telegram‚ÄëAPI.

Spring / Lombok:

- `@Component` ‚Äî –¥–µ–ª–∞–µ—Ç –±–∏–Ω –¥–ª—è DI.
- `@RequiredArgsConstructor` ‚Äî –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä —Å `final` –ø–æ–ª—è–º–∏.
- `@Slf4j` ‚Äî –ª–æ–≥–≥–µ—Ä.

### –ü–æ–ª—è –∫–ª–∞—Å—Å–∞

```java
private final UserService userService;
private final ShopService shopService;

@Autowired
@Lazy
private Bot bot;
```

- `userService` ‚Äî —Å–µ—Ä–≤–∏—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:
  - —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ—Ç –Ω–æ–≤–æ–≥–æ `User`,
  - –æ–±–Ω–æ–≤–ª—è–µ—Ç —Ä–æ–ª–∏ –∏ —Ç.–¥.
- `shopService` ‚Äî —Å–µ—Ä–≤–∏—Å –º–∞–≥–∞–∑–∏–Ω–æ–≤:
  - –Ω—É–∂–µ–Ω, —á—Ç–æ–±—ã –ø–æ–Ω—è—Ç—å, –µ—Å—Ç—å –ª–∏ —É–∂–µ —É —é–∑–µ—Ä–∞ –º–∞–≥–∞–∑–∏–Ω, –∏ –∞–∫—Ç–∏–≤–µ–Ω –ª–∏ –æ–Ω.

`bot`:

- —ç—Ç–æ –≥–ª–∞–≤–Ω—ã–π –∫–ª–∞—Å—Å `Bot`, —á–µ—Ä–µ–∑ –Ω–µ–≥–æ –º—ã:
  - –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è: `bot.execute(...)`,
  - –≤—ã–∑—ã–≤–∞–µ–º `bot.sendShopMenu(...)` —á—Ç–æ–±—ã –ø–æ–∫–∞–∑–∞—Ç—å –º–µ–Ω—é –º–∞–≥–∞–∑–∏–Ω–∞.
- `@Lazy` + `@Autowired`:
  - `Bot` —Å—Å—ã–ª–∞–µ—Ç—Å—è –Ω–∞ `StartCommandHandler`,
  - `StartCommandHandler` —Å—Å—ã–ª–∞–µ—Ç—Å—è –Ω–∞ `Bot`,
  - —á—Ç–æ–±—ã –æ–Ω–∏ –Ω–µ –∑–∞—Ü–∏–∫–ª–∏–ª–∏—Å—å –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏, Spring –¥–µ–ª–∞–µ—Ç "–ª–µ–Ω–∏–≤—ã–π" –ø—Ä–æ–∫—Å–∏.

---

# 2. –ì–ª–∞–≤–Ω—ã–π –º–µ—Ç–æ–¥: `handle(Update update)`

```java
public void handle(Update update) {
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –≤ Update –µ—Å—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ
    if (!update.hasMessage()) {
        log.warn("Update –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç —Å–æ–æ–±—â–µ–Ω–∏—è: {}", update);
        return;
    }

    Message message = update.getMessage();

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å–æ–¥–µ—Ä–∂–∏—Ç —Ç–µ–∫—Å—Ç
    if (!message.hasText()) {
        log.warn("–°–æ–æ–±—â–µ–Ω–∏–µ –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç —Ç–µ–∫—Å—Ç–∞: {}", message);
        return;
    }

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —ç—Ç–æ –∫–æ–º–∞–Ω–¥–∞ /start
    if (!message.getText().equals("/start")) {
        log.warn("–ü–æ–ª—É—á–µ–Ω–∞ –∫–æ–º–∞–Ω–¥–∞ –Ω–µ /start: {}", message.getText());
        return;
    }

    // –ò–∑–≤–ª–µ–∫–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    Long telegramId = message.getFrom().getId();
    String firstName = message.getFrom().getFirstName();
    String lastName = message.getFrom().getLastName();

    // –§–æ—Ä–º–∏—Ä—É–µ–º –ø–æ–ª–Ω–æ–µ –∏–º—è (–µ—Å–ª–∏ lastName null, –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ç–æ–ª—å–∫–æ firstName)
    String fullName = lastName != null
            ? firstName + " " + lastName
            : firstName;

    log.info("–û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–æ–º–∞–Ω–¥—ã /start –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: telegramId={}, fullName={}",
            telegramId, fullName);

    // –ü–æ–ª—É—á–∞–µ–º ID —á–∞—Ç–∞ (–∫—É–¥–∞ –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å –æ—Ç–≤–µ—Ç)
    Long chatId = message.getChatId();

    // –ü—ã—Ç–∞–µ–º—Å—è –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    try {
        // –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∂–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω - registerUser –≤—ã–±—Ä–æ—Å–∏—Ç IllegalArgumentException
        userService.registerUser(telegramId, fullName);

        // –ï—Å–ª–∏ –¥–æ—à–ª–∏ —Å—é–¥–∞ - –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É—Å–ø–µ—à–Ω–æ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω
        log.info("–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É—Å–ø–µ—à–Ω–æ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω: telegramId={}", telegramId);

        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
        sendWelcomeMessage(chatId, fullName, true);  // true = –Ω–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å

    } catch (IllegalArgumentException e) {
        // –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∂–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω - –Ω–µ –ø—Ä–æ–±–ª–µ–º–∞, —Ä–µ—à–∞–µ–º —á—Ç–æ –µ–º—É –ø–æ–∫–∞–∑–∞—Ç—å –¥–∞–ª—å—à–µ
        log.debug("–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∂–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω: telegramId={}", telegramId);

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –º–∞–≥–∞–∑–∏–Ω
        var shopOptional = shopService.findByUserTelegramId(telegramId);
        if (shopOptional.isPresent()) {
            Shop shop = shopOptional.get();

            if (Boolean.TRUE.equals(shop.getIsActive())) {
                // –ê–∫—Ç–∏–≤–Ω—ã–π –º–∞–≥–∞–∑–∏–Ω: —Å—Ä–∞–∑—É –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é –º–∞–≥–∞–∑–∏–Ω–∞ —Å Reply-–∫–ª–∞–≤–∏–∞—Ç—É—Ä–æ–π
                bot.sendShopMenu(chatId, shop,
                        String.format("–ü—Ä–∏–≤–µ—Ç, %s! üëã\n\n–í–æ—Ç –º–µ–Ω—é —Ç–≤–æ–µ–≥–æ –º–∞–≥–∞–∑–∏–Ω–∞:", fullName));
            } else {
                // –ú–∞–≥–∞–∑–∏–Ω –µ—Å—Ç—å, –Ω–æ –∂–¥—ë—Ç –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ –∞–¥–º–∏–Ω–æ–º
                SendMessage msg = SendMessage.builder()
                        .chatId(chatId.toString())
                        .text("–ü—Ä–∏–≤–µ—Ç, " + fullName + "! üëã\n\n" +
                                "–¢–≤–æ–π –º–∞–≥–∞–∑–∏–Ω —É–∂–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω –∏ –∂–¥—ë—Ç –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º.\n" +
                                "–ü–æ—Å–ª–µ –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ –∑–¥–µ—Å—å –ø–æ—è–≤—è—Ç—Å—è –∫–Ω–æ–ø–∫–∏ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∑–∞–∫–∞–∑–∞–º–∏.")
                        .build();
                try {
                    bot.execute(msg);
                } catch (TelegramApiException ex) {
                    log.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —Å–æ–æ–±—â–µ–Ω–∏—è –æ–± –æ–∂–∏–¥–∞–Ω–∏–∏ –∞–∫—Ç–∏–≤–∞—Ü–∏–∏: chatId={}", chatId, ex);
                }
            }
        } else {
            // –ú–∞–≥–∞–∑–∏–Ω–∞ –µ—â—ë –Ω–µ—Ç ‚Äî —Å—Ç–∞—Ä–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ: –≤—ã–±—Ä–∞—Ç—å —Ä–æ–ª—å
            sendWelcomeMessage(chatId, fullName, false);  // false = —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
        }

    } catch (Exception e) {
        // –°–µ—Ä—å—ë–∑–Ω–∞—è –æ—à–∏–±–∫–∞ - –ª–æ–≥–∏—Ä—É–µ–º –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ
        log.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: telegramId={}", telegramId, e);
        sendErrorMessage(chatId);
    }
}
```

–¢–µ–ø–µ—Ä—å —Ä–∞–∑–±–µ—Ä—ë–º –∫–∞–∂–¥—É—é —á–∞—Å—Ç—å.

---

## 2.1. –ß—Ç–æ —Ç–∞–∫–æ–µ `Update`, `hasMessage()` –∏ `getMessage()`

```java
public void handle(Update update) {
    if (!update.hasMessage()) {
        log.warn("Update –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç —Å–æ–æ–±—â–µ–Ω–∏—è: {}", update);
        return;
    }

    Message message = update.getMessage();
    ...
}
```

- `Update` ‚Äî **–æ–¥–Ω–æ —Å–æ–±—ã—Ç–∏–µ**, –∫–æ—Ç–æ—Ä–æ–µ –ø—Ä–∏—Å–ª–∞–ª Telegram –±–æ—Ç—É.
  - –ú–æ–∂–µ—Ç —Å–æ–¥–µ—Ä–∂–∞—Ç—å:
    - –æ–±—ã—á–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ (`message`),
    - –Ω–∞–∂–∞—Ç–∏–µ –Ω–∞ –∫–Ω–æ–ø–∫—É (`callbackQuery`),
    - –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ (`editedMessage`),
    - –∏ –ø—Ä–æ—á–µ–µ.

- `update.hasMessage()`:
  - –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç `true`, –µ—Å–ª–∏ –≤ —ç—Ç–æ–º –∞–ø–¥–µ–π—Ç–µ **–µ—Å—Ç—å –ø–æ–ª–µ `message`**.
  - –ï—Å–ª–∏ –Ω–µ—Ç ‚Äî –∑–Ω–∞—á–∏—Ç —ç—Ç–æ –Ω–µ —Ç–µ–∫—Å—Ç–æ–≤–∞—è –∫–æ–º–∞–Ω–¥–∞, –∞ —á—Ç–æ‚Äë—Ç–æ –¥—Ä—É–≥–æ–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä, callback).

- `update.getMessage()`:
  - –¥–æ—Å—Ç–∞—ë—Ç –æ–±—ä–µ–∫—Ç `Message` –∏–∑ –∞–ø–¥–µ–π—Ç–∞.
  - `Message` ‚Äî —ç—Ç–æ —É–∂–µ "–∫–æ–Ω–≤–µ—Ä—Ç —Å —Ç–µ–∫—Å—Ç–æ–º":
    - –∫—Ç–æ –Ω–∞–ø–∏—Å–∞–ª (`getFrom()`),
    - –≤ –∫–∞–∫–æ–π —á–∞—Ç (`getChatId()`),
    - –∫–∞–∫–æ–π —Ç–µ–∫—Å—Ç (`getText()`),
    - –µ—Å—Ç—å –ª–∏ –∫–æ–Ω—Ç–∞–∫—Ç/—Ñ–æ—Ç–æ/–¥–æ–∫—É–º–µ–Ω—Ç—ã –∏ —Ç.–¥.

–ï—Å–ª–∏ –±—ã –º—ã –Ω–µ –¥–µ–ª–∞–ª–∏ –ø—Ä–æ–≤–µ—Ä–∫—É `hasMessage()` –∏ —Å—Ä–∞–∑—É –ø–æ–ª–µ–∑–ª–∏ –≤ `getMessage()`,
—Ç–æ –Ω–∞ –∞–ø–¥–µ–π—Ç–µ –±–µ–∑ —Å–æ–æ–±—â–µ–Ω–∏—è —Å–ª–æ–≤–∏–ª–∏ –±—ã `NullPointerException`.

---

## 2.2. –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —ç—Ç–æ —Ç–µ–∫—Å—Ç –∏ –∏–º–µ–Ω–Ω–æ `/start`

```java
if (!message.hasText()) {
    log.warn("–°–æ–æ–±—â–µ–Ω–∏–µ –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç —Ç–µ–∫—Å—Ç–∞: {}", message);
    return;
}

if (!message.getText().equals("/start")) {
    log.warn("–ü–æ–ª—É—á–µ–Ω–∞ –∫–æ–º–∞–Ω–¥–∞ –Ω–µ /start: {}", message.getText());
    return;
}
```

- `message.hasText()`:
  - `true`, –µ—Å–ª–∏ –≤ —ç—Ç–æ–º `Message` –µ—Å—Ç—å **—Ç–µ–∫—Å—Ç**.
  - –ï—Å–ª–∏ —á–µ–ª–æ–≤–µ–∫ –ø—Ä–∏—Å–ª–∞–ª —Ç–æ–ª—å–∫–æ —Å—Ç–∏–∫–µ—Ä/—Ñ–æ—Ç–æ/–≥–µ–æ–ª–æ–∫–∞—Ü–∏—é ‚Äî —Ç–µ–∫—Å—Ç–∞ –Ω–µ—Ç.

- `message.getText()`:
  - —Å—Ç—Ä–æ–∫–∞ —Å —Ç–µ–∫—Å—Ç–æ–º —Å–æ–æ–±—â–µ–Ω–∏—è, –Ω–∞–ø—Ä–∏–º–µ—Ä:
    - `"/start"`,
    - `"–ü—Ä–∏–≤–µ—Ç"`,
    - `"üì¶ –°–æ–∑–¥–∞—Ç—å –∑–∞–∫–∞–∑"` (–∫–æ–≥–¥–∞ –∂–º—É—Ç –∫–Ω–æ–ø–∫—É –æ–±—ã—á–Ω–æ–π Reply‚Äë–∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã).

–ú—ã —Ö–æ—Ç–∏–º, —á—Ç–æ–±—ã —ç—Ç–æ—Ç —Ö–µ–Ω–¥–ª–µ—Ä —Ä–µ–∞–≥–∏—Ä–æ–≤–∞–ª **—Ç–æ–ª—å–∫–æ** –Ω–∞ –∫–æ–º–∞–Ω–¥—É `/start`.
–í—Å—ë –æ—Å—Ç–∞–ª—å–Ω–æ–µ ‚Äî –Ω–µ –µ–≥–æ –∑–æ–Ω–∞ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏.

–ü–æ—ç—Ç–æ–º—É:

- –µ—Å–ª–∏ —Ç–µ–∫—Å—Ç –≤–æ–æ–±—â–µ –ù–ï `/start` ‚Äî –≤—ã—Ö–æ–¥–∏–º –∏ –¥–∞—ë–º —à–∞–Ω—Å –¥—Ä—É–≥–∏–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞–º (Bot –¥–∞–ª—å—à–µ –Ω–µ –±—É–¥–µ—Ç –∑–≤–∞—Ç—å —ç—Ç–æ—Ç —Ö–µ–Ω–¥–ª–µ—Ä).

---

## 2.3. –î–æ—Å—Ç–∞—ë–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: `getFrom()`, `getId()`, –∏–º—è/—Ñ–∞–º–∏–ª–∏—è

```java
Long telegramId = message.getFrom().getId();
String firstName = message.getFrom().getFirstName();
String lastName = message.getFrom().getLastName();
```

–ß—Ç–æ –∑–∞ —Ü–µ–ø–æ—á–∫–∞:

- `message` ‚Äî –æ–±—ä–µ–∫—Ç `Message`.
- `message.getFrom()` ‚Äî **–∫—Ç–æ –æ—Ç–ø—Ä–∞–≤–∏–ª —Å–æ–æ–±—â–µ–Ω–∏–µ**:
  - —ç—Ç–æ `org.telegram.telegrambots.meta.api.objects.User` (–Ω–µ –Ω–∞—à `model.User`).
- `.getId()` ‚Äî Telegram‚ÄëID —ç—Ç–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:
  - —É–Ω–∏–∫–∞–ª—å–Ω–æ–µ —á–∏—Å–ª–æ,
  - –º—ã –∏—Å–ø–æ–ª—å–∑—É–µ–º –µ–≥–æ –∫–∞–∫ –∫–ª—é—á –≤ –Ω–∞—à–µ–π —Ç–∞–±–ª–∏—Ü–µ `users` (`users.telegram_id`).

–ò–º—è/—Ñ–∞–º–∏–ª–∏—è:

- `.getFirstName()` ‚Äî –∏–º—è –≤ –ø—Ä–æ—Ñ–∏–ª–µ Telegram (`–ò–ª–∞—Ä–∏–æ–Ω`).
- `.getLastName()` ‚Äî —Ñ–∞–º–∏–ª–∏—è (–º–æ–∂–µ—Ç –±—ã—Ç—å `null`).

–°–∫–ª–µ–π–∫–∞:

```java
String fullName = lastName != null
        ? firstName + " " + lastName
        : firstName;
```

- –µ—Å–ª–∏ —Ñ–∞–º–∏–ª–∏—è –µ—Å—Ç—å ‚Üí `"–ò–º—è –§–∞–º–∏–ª–∏—è"`,
- –µ—Å–ª–∏ –Ω–µ—Ç ‚Üí –ø—Ä–æ—Å—Ç–æ `"–ò–º—è"`.

–≠—Ç–æ `fullName` –º—ã –∫–ª–∞–¥—ë–º –≤ –Ω–∞—à—É —Å—É—â–Ω–æ—Å—Ç—å `User` –ø—Ä–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏.

–õ–æ–≥:

```java
log.info("–û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–æ–º–∞–Ω–¥—ã /start –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: telegramId={}, fullName={}",
        telegramId, fullName);
```

–í –ª–æ–≥–µ —É–≤–∏–¥–∏—à—å, –∫—Ç–æ –∏–º–µ–Ω–Ω–æ —Å—Ç–∞—Ä—Ç–∞–Ω—É–ª –±–æ—Ç–∞.

---

## 2.4. `chatId` ‚Äî –∫—É–¥–∞ –æ—Ç–≤–µ—á–∞—Ç—å

```java
Long chatId = message.getChatId();
```

- `getChatId()` ‚Äî ID —á–∞—Ç–∞, –≤ –∫–æ—Ç–æ—Ä—ã–π –ø—Ä–∏—à–ª–æ —Å–æ–æ–±—â–µ–Ω–∏–µ:
  - –≤ –ª–∏—á–∫–µ: ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è,
  - –≤ –≥—Ä—É–ø–ø–µ: ID –≥—Ä—É–ø–ø—ã,
  - –≤ –∫–∞–Ω–∞–ª–µ: ID –∫–∞–Ω–∞–ª–∞.

–ë–æ—Ç –≤—Å–µ–≥–¥–∞ –æ—Ç–≤–µ—á–∞–µ—Ç –≤ –ö–û–ù–ö–†–ï–¢–ù–´–ô —á–∞—Ç,
–ø–æ—ç—Ç–æ–º—É –≤—Å–µ `SendMessage` –¥–∞–ª—å—à–µ –∏—Å–ø–æ–ª—å–∑—É—é—Ç –∏–º–µ–Ω–Ω–æ `chatId`.

–ê–Ω–∞–ª–æ–≥–∏—è:

- `telegramId` ‚Äî "–ø–∞—Å–ø–æ—Ä—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è".
- `chatId` ‚Äî "–∞–¥—Ä–µ—Å –∫–æ–º–Ω–∞—Ç—ã, –∫—É–¥–∞ –ø–∏—Å–∞—Ç—å –æ—Ç–≤–µ—Ç".

---

## 2.5. –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —á–µ—Ä–µ–∑ `UserService`

```java
try {
    // –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∂–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω - registerUser –≤—ã–±—Ä–æ—Å–∏—Ç IllegalArgumentException
    userService.registerUser(telegramId, fullName);

    // –ï—Å–ª–∏ –¥–æ—à–ª–∏ —Å—é–¥–∞ - –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É—Å–ø–µ—à–Ω–æ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω
    log.info("–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É—Å–ø–µ—à–Ω–æ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω: telegramId={}", telegramId);

    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
    sendWelcomeMessage(chatId, fullName, true);  // true = –Ω–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å

} catch (IllegalArgumentException e) {
    // –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∂–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω - –Ω–µ –ø—Ä–æ–±–ª–µ–º–∞, —Ä–µ—à–∞–µ–º —á—Ç–æ –µ–º—É –ø–æ–∫–∞–∑–∞—Ç—å –¥–∞–ª—å—à–µ
    ...
} catch (Exception e) {
    // –°–µ—Ä—å—ë–∑–Ω–∞—è –æ—à–∏–±–∫–∞ - –ª–æ–≥–∏—Ä—É–µ–º –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ
    ...
}
```

### –ß—Ç–æ –¥–µ–ª–∞–µ—Ç `userService.registerUser`

–°–º–æ—Ç—Ä–∏ `UserService.registerUser` (—Ç—ã —É–∂–µ —Ä–∞–∑–±–∏—Ä–∞–ª –µ–≥–æ –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–º –≥–∞–π–¥–∏–∫–µ):

- –ø—Ä–æ–≤–µ—Ä—è–µ—Ç, –µ—Å—Ç—å –ª–∏ —é–∑–µ—Ä —Å —Ç–∞–∫–∏–º `telegramId` –≤ `users`,
- –µ—Å–ª–∏ –µ—Å—Ç—å:
  - –∫–∏–¥–∞–µ—Ç `IllegalArgumentException("–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∂–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω!")`,
- –µ—Å–ª–∏ –Ω–µ—Ç:
  - —Å–æ–∑–¥–∞—ë—Ç –Ω–æ–≤–æ–≥–æ `User` —Å —ç—Ç–∏–º `telegramId` –∏ `fullName`,
  - —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –≤ –ë–î.

–ü–æ—ç—Ç–æ–º—É:

- –µ—Å–ª–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –ø—Ä–æ—à–ª–∞ **–±–µ–∑ –∏—Å–∫–ª—é—á–µ–Ω–∏—è**:
  - —ç—Ç–æ **–Ω–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å**,
  - –µ–º—É –Ω–∞–¥–æ –ø–æ–∫–∞–∑–∞—Ç—å –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ –∏ –≤—ã–±–æ—Ä —Ä–æ–ª–∏.

```java
sendWelcomeMessage(chatId, fullName, true);
```

- –µ—Å–ª–∏ —Å–ª–æ–≤–∏–ª–∏ **`IllegalArgumentException`**:
  - –∑–Ω–∞—á–∏—Ç, —é–∑–µ—Ä —É–∂–µ –±—ã–ª –≤ –±–∞–∑–µ,
  - —ç—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–∞—è —Å–∏—Ç—É–∞—Ü–∏—è,
  - –Ω–∞–¥–æ –ø—Ä–æ—Å—Ç–æ –ø–æ–Ω—è—Ç—å, —á—Ç–æ –µ–º—É —Ç–µ–ø–µ—Ä—å –ø–æ–∫–∞–∑–∞—Ç—å.

- –µ—Å–ª–∏ —Å–ª–æ–≤–∏–ª–∏ **–¥—Ä—É–≥–æ–µ –∏—Å–∫–ª—é—á–µ–Ω–∏–µ**:
  - —ç—Ç–æ —É–∂–µ —á—Ç–æ‚Äë—Ç–æ —Ä–µ–∞–ª—å–Ω–æ —Å–ª–æ–º–∞–ª–æ—Å—å (–ë–î —É–ø–∞–ª–∞, –∏ —Ç.–¥.),
  - –ª–æ–≥–∏—Ä—É–µ–º –∫–∞–∫ –æ—à–∏–±–∫—É –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤ —á–∞—Ç "–ø—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞".

---

## 2.6. –ü–æ–≤–µ–¥–µ–Ω–∏–µ –¥–ª—è —É–∂–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

–≠—Ç–æ—Ç –∫—É—Å–æ–∫ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è, –µ—Å–ª–∏ `registerUser` –∫–∏–Ω—É–ª `IllegalArgumentException`:

```java
} catch (IllegalArgumentException e) {
    // –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∂–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω - –Ω–µ –ø—Ä–æ–±–ª–µ–º–∞, —Ä–µ—à–∞–µ–º —á—Ç–æ –µ–º—É –ø–æ–∫–∞–∑–∞—Ç—å –¥–∞–ª—å—à–µ
    log.debug("–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∂–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω: telegramId={}", telegramId);

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –º–∞–≥–∞–∑–∏–Ω
    var shopOptional = shopService.findByUserTelegramId(telegramId);
    if (shopOptional.isPresent()) {
        Shop shop = shopOptional.get();

        if (Boolean.TRUE.equals(shop.getIsActive())) {
            // –ê–∫—Ç–∏–≤–Ω—ã–π –º–∞–≥–∞–∑–∏–Ω: —Å—Ä–∞–∑—É –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é –º–∞–≥–∞–∑–∏–Ω–∞ —Å Reply-–∫–ª–∞–≤–∏–∞—Ç—É—Ä–æ–π
            bot.sendShopMenu(chatId, shop,
                    String.format("–ü—Ä–∏–≤–µ—Ç, %s! üëã\n\n–í–æ—Ç –º–µ–Ω—é —Ç–≤–æ–µ–≥–æ –º–∞–≥–∞–∑–∏–Ω–∞:", fullName));
        } else {
            // –ú–∞–≥–∞–∑–∏–Ω –µ—Å—Ç—å, –Ω–æ –∂–¥—ë—Ç –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ –∞–¥–º–∏–Ω–æ–º
            SendMessage msg = SendMessage.builder()
                    .chatId(chatId.toString())
                    .text("–ü—Ä–∏–≤–µ—Ç, " + fullName + "! üëã\n\n" +
                            "–¢–≤–æ–π –º–∞–≥–∞–∑–∏–Ω —É–∂–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω –∏ –∂–¥—ë—Ç –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º.\n" +
                            "–ü–æ—Å–ª–µ –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ –∑–¥–µ—Å—å –ø–æ—è–≤—è—Ç—Å—è –∫–Ω–æ–ø–∫–∏ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∑–∞–∫–∞–∑–∞–º–∏.")
                    .build();
            try {
                bot.execute(msg);
            } catch (TelegramApiException ex) {
                log.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —Å–æ–æ–±—â–µ–Ω–∏—è –æ–± –æ–∂–∏–¥–∞–Ω–∏–∏ –∞–∫—Ç–∏–≤–∞—Ü–∏–∏: chatId={}", chatId, ex);
            }
        }
    } else {
        // –ú–∞–≥–∞–∑–∏–Ω–∞ –µ—â—ë –Ω–µ—Ç ‚Äî —Å—Ç–∞—Ä–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ: –≤—ã–±—Ä–∞—Ç—å —Ä–æ–ª—å
        sendWelcomeMessage(chatId, fullName, false);  // false = —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
    }
}
```

–õ–æ–≥–∏–∫–∞:

1. –ò—â–µ–º –º–∞–≥–∞–∑–∏–Ω –ø–æ `telegramId`:

```java
var shopOptional = shopService.findByUserTelegramId(telegramId);
```

2. –ï—Å–ª–∏ –º–∞–≥–∞–∑–∏–Ω **–µ—Å—Ç—å**:

   - –ï—Å–ª–∏ `shop.isActive == true`:

   ```java
   bot.sendShopMenu(chatId, shop,
           String.format("–ü—Ä–∏–≤–µ—Ç, %s! üëã\n\n–í–æ—Ç –º–µ–Ω—é —Ç–≤–æ–µ–≥–æ –º–∞–≥–∞–∑–∏–Ω–∞:", fullName));
   ```

   - —Ç.–µ. —Å—Ä–∞–∑—É –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –º–µ–Ω—é –º–∞–≥–∞–∑–∏–Ω–∞ (Reply‚Äë–∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞ —Å "–°–æ–∑–¥–∞—Ç—å –∑–∞–∫–∞–∑", "–ú–æ–∏ –∑–∞–∫–∞–∑—ã", "–ú–æ–π –º–∞–≥–∞–∑–∏–Ω").

   - –ï—Å–ª–∏ `isActive == false`:
     - —à–ª—ë–º —Å–æ–æ–±—â–µ–Ω–∏–µ:
       - –º–∞–≥–∞–∑–∏–Ω –∑–∞—Ä–µ–≥–∞–Ω,
       - –Ω–æ –∂–¥—ë—Ç –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ –∞–¥–º–∏–Ω–æ–º,
       - "–ø–æ—è–≤—è—Ç—Å—è –∫–Ω–æ–ø–∫–∏ –ø–æ–∑–∂–µ".

3. –ï—Å–ª–∏ –º–∞–≥–∞–∑–∏–Ω–∞ **–Ω–µ—Ç**:

```java
sendWelcomeMessage(chatId, fullName, false);
```

- –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ —Å –≤—ã–±–æ—Ä–æ–º —Ä–æ–ª–∏, –Ω–æ —Ñ–ª–∞–≥ `isNewUser = false`:
  - —Ç–µ–∫—Å—Ç –±—É–¥–µ—Ç –Ω–µ–º–Ω–æ–≥–æ –¥—Ä—É–≥–æ–π ("—Ç—ã —É–∂–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω, –≤—ã–±–µ—Ä–∏ —Ä–æ–ª—å").

---

## 2.7. –û–±—â–∞—è –æ—à–∏–±–∫–∞

```java
} catch (Exception e) {
    // –°–µ—Ä—å—ë–∑–Ω–∞—è –æ—à–∏–±–∫–∞ - –ª–æ–≥–∏—Ä—É–µ–º –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ
    log.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: telegramId={}", telegramId, e);
    sendErrorMessage(chatId);
}
```

- –ï—Å–ª–∏ —á—Ç–æ‚Äë—Ç–æ –ø–æ—à–ª–æ —Å–æ–≤—Å–µ–º –Ω–µ –ø–æ –ø–ª–∞–Ω—É (–ë–î —É–ø–∞–ª–∞, —á—Ç–æ‚Äë—Ç–æ —Å–ª–æ–º–∞–ª–æ—Å—å –≤–Ω—É—Ç—Ä–∏ —Å–µ—Ä–≤–∏—Å–æ–≤):
  - –ø–∏—à–µ–º —Å—Ç–µ–∫—Ç—Ä–µ–π—Å –≤ –ª–æ–≥,
  - –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –∞–∫–∫—É—Ä–∞—Ç–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ "–ø—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞, –ø–æ–ø—Ä–æ–±—É–π –ø–æ–∑–∂–µ".

---

# 3. `sendWelcomeMessage` ‚Äî –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ –∏ –≤—ã–±–æ—Ä —Ä–æ–ª–∏

```java
private void sendWelcomeMessage(Long chatId, String fullName, boolean isNewUser) {
    String text;

    if (isNewUser) {
        text = String.format(
                "–ü—Ä–∏–≤–µ—Ç, %s! üëã\n\n" +
                        "–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ Flower Delivery Bot!\n\n" +
                        "–í—ã–±–µ—Ä–∏—Ç–µ —Å–≤–æ—é —Ä–æ–ª—å: ",
                fullName
        );
    } else {
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —É–∂–µ —Ä–æ–ª—å —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        Long telegramId = null;
        try {
            // –ü–æ–ª—É—á–∞–µ–º telegramId –∏–∑ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ (–Ω—É–∂–Ω–æ –±—É–¥–µ—Ç –ø–µ—Ä–µ–¥–∞–≤–∞—Ç—å)
            // –ü–æ–∫–∞ —á—Ç–æ –ø—Ä–æ—Å—Ç–æ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –∫–Ω–æ–ø–∫–∞–º–∏
            text = String.format(
                    "–ü—Ä–∏–≤–µ—Ç, %s! üëã\n\n" +
                            "–¢—ã —É–∂–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω –≤ —Å–∏—Å—Ç–µ–º–µ.\n\n" +
                            "–í—ã–±–µ—Ä–∏ —Å–≤–æ—é —Ä–æ–ª—å:",
                    fullName
            );
        } catch (Exception e) {
            text = String.format(
                    "–ü—Ä–∏–≤–µ—Ç, %s! üëã\n\n" +
                            "–í—ã–±–µ—Ä–∏ —Å–≤–æ—é —Ä–æ–ª—å:",
                    fullName
            );
        }
    }

    try {
        // –°–æ–∑–¥–∞–µ–º –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É —Å –∫–Ω–æ–ø–∫–∞–º–∏
        InlineKeyboardMarkup keyboardMarkup = createRoleSelectionKeyboard();

        SendMessage message = SendMessage.builder()
                .chatId(chatId.toString())
                .text(text)
                .replyMarkup(keyboardMarkup)  // –ü—Ä–∏–∫—Ä–µ–ø–ª—è–µ–º –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É –∫ —Å–æ–æ–±—â–µ–Ω–∏—é
                .build();

        bot.execute(message);
        log.info("–ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –∫–Ω–æ–ø–∫–∞–º–∏ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ: chatId={}", chatId);

    } catch (TelegramApiException e) {
        log.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è: chatId={}", chatId, e);
    }
}
```

–ö–ª—é—á–µ–≤—ã–µ –º–æ–º–µ–Ω—Ç—ã:

- –§–æ—Ä–º–∏—Ä—É–µ–º —Ä–∞–∑–Ω—ã–π —Ç–µ–∫—Å—Ç –¥–ª—è:
  - `isNewUser = true` ‚Äî –ø–µ—Ä–≤—ã–π —Ä–∞–∑ –≤ –±–æ—Ç–µ.
  - `isNewUser = false` ‚Äî —É–∂–µ –±—ã–ª, –Ω–æ –±–µ–∑ –º–∞–≥–∞–∑–∏–Ω–∞.

- `createRoleSelectionKeyboard()` ‚Äî —Å–æ–∑–¥–∞—ë—Ç inline‚Äë–∫–ª–∞–≤–∏–∞—Ç—É—Ä—É —Å –∫–Ω–æ–ø–∫–∞–º–∏:
  - "üè™ –ú–∞–≥–∞–∑–∏–Ω" ‚Üí `callbackData = "role_shop"`,
  - "üöó –ö—É—Ä—å–µ—Ä" ‚Üí `callbackData = "role_courier"`.

- `bot.execute(message)` ‚Äî —Ñ–∏–∑–∏—á–µ—Å–∫–∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ —á–µ—Ä–µ–∑ Telegram API.

–î–∞–ª—å—à–µ –Ω–∞–∂–∞—Ç–∏—è —ç—Ç–∏—Ö –∫–Ω–æ–ø–æ–∫ –±—É–¥—É—Ç –ª–æ–≤–∏—Ç—å –≤ `CallbackQueryHandler.handle(...)`.

---

# 4. `createRoleSelectionKeyboard` ‚Äî inline‚Äë–∫–Ω–æ–ø–∫–∏ —Ä–æ–ª–µ–π

```java
private InlineKeyboardMarkup createRoleSelectionKeyboard() {
    // –°–æ–∑–¥–∞–µ–º –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É (—ç—Ç–æ –∫–∞–∫ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –∫–Ω–æ–ø–æ–∫)
    InlineKeyboardMarkup keyboardMarkup = new InlineKeyboardMarkup();

    // –°–ø–∏—Å–æ–∫ —Å—Ç—Ä–æ–∫ –∫–Ω–æ–ø–æ–∫ (–∫–∞–∂–¥–∞—è —Å—Ç—Ä–æ–∫–∞ - —ç—Ç–æ List<InlineKeyboardButton>)
    List<List<InlineKeyboardButton>> keyboard = new ArrayList<>();

    // –ü–µ—Ä–≤–∞—è —Å—Ç—Ä–æ–∫–∞: –∫–Ω–æ–ø–∫–∞ "–ú–∞–≥–∞–∑–∏–Ω"
    List<InlineKeyboardButton> row1 = new ArrayList<>();
    InlineKeyboardButton shopButton = new InlineKeyboardButton();
    shopButton.setText(" üíê –ú–∞–≥–∞–∑–∏–Ω");
    shopButton.setCallbackData("role_shop");  // –≠—Ç–æ –¥–∞–Ω–Ω—ã–µ –∫–æ—Ç–æ—Ä—ã–µ –≤–µ—Ä–Ω—É—Ç—Å—è –ø—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏
    row1.add(shopButton);

    // –í—Ç–æ—Ä–∞—è —Å—Ç—Ä–æ–∫–∞: –∫–Ω–æ–ø–∫–∞ "–ö—É—Ä—å–µ—Ä"
    List<InlineKeyboardButton> row2 = new ArrayList<>();
    InlineKeyboardButton courierButton = new InlineKeyboardButton();
    courierButton.setText("üöó –ö—É—Ä—å–µ—Ä");
    courierButton.setCallbackData("role_courier");  // –≠—Ç–æ –¥–∞–Ω–Ω—ã–µ –∫–æ—Ç–æ—Ä—ã–µ –≤–µ—Ä–Ω—É—Ç—Å—è –ø—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏
    row2.add(courierButton);

    // –î–æ–±–∞–≤–ª—è–µ–º —Å—Ç—Ä–æ–∫–∏ –≤ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É
    keyboard.add(row1);
    keyboard.add(row2);

    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É
    keyboardMarkup.setKeyboard(keyboard);

    return keyboardMarkup;
}
```

–ß—Ç–æ –≤–∞–∂–Ω–æ –ø–æ–Ω—è—Ç—å:

- Inline‚Äë–∫–Ω–æ–ø–∫–∏ ‚Äî —ç—Ç–æ **–Ω–µ** –æ–±—ã—á–Ω–∞—è –∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞ –≤–Ω–∏–∑—É (Reply), –∞ –∫–Ω–æ–ø–∫–∏ –ü–û–î —Å–æ–æ–±—â–µ–Ω–∏–µ–º.
- –ü—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏:
  - Telegram –Ω–µ —à–ª—ë—Ç —Ç–µ–∫—Å—Ç `"–ú–∞–≥–∞–∑–∏–Ω"`,
  - –æ–Ω —à–ª—ë—Ç `CallbackQuery`, –≥–¥–µ:
    - `data = "role_shop"` –∏–ª–∏ `"role_courier"`.

–î–∞–ª—å—à–µ `CallbackQueryHandler` –ø–æ —ç—Ç–∏–º `callbackData` —Ä–µ—à–∞–µ—Ç:

- –∫–∞–∫—É—é —Ä–æ–ª—å –ø–æ—Å—Ç–∞–≤–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é,
- –∫–∞–∫–æ–π —Å—Ü–µ–Ω–∞—Ä–∏–π —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –∑–∞–ø—É—Å—Ç–∏—Ç—å.

---

# 5. `sendErrorMessage` ‚Äî —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ

```java
private void sendErrorMessage(Long chatId) {
    String text = "‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏.\n\n" +
            "–ü–æ–ø—Ä–æ–±—É–π –ø–æ–∑–∂–µ –∏–ª–∏ —Å–≤—è–∂–∏—Å—å —Å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º.";

    try {
        SendMessage message = SendMessage.builder()
                .chatId(chatId.toString())
                .text(text)
                .build();

        bot.execute(message);
        log.info("–°–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ: chatId={}", chatId);

    } catch (TelegramApiException e) {
        log.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —Å–æ–æ–±—â–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–µ: chatId={}", chatId, e);
    }
}
```

–ü—Ä–æ—Å—Ç–æ –∞–∫–∫—É—Ä–∞—Ç–Ω—ã–π fallback, —á—Ç–æ–±—ã —é–∑–µ—Ä –Ω–µ –∑–∞–≤–∏—Å –≤ —Ç–∏—à–∏–Ω–µ, –µ—Å–ª–∏ —á—Ç–æ‚Äë—Ç–æ –æ—Ç–≤–∞–ª–∏–ª–æ—Å—å.

---

## –ò—Ç–æ–≥–æ–≤–∞—è —Å—Ö–µ–º–∞ —Ç–æ–≥–æ, —á—Ç–æ –¥–µ–ª–∞–µ—Ç StartCommandHandler

```text
1) –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–∏—à–µ—Ç /start
   ‚Üì
2) Bot.onUpdateReceived(update)
   ‚Üì
3) StartCommandHandler.handle(update)
   - —É–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ —ç—Ç–æ –≤–æ–æ–±—â–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –∏ —á—Ç–æ —Ç–µ–∫—Å—Ç = "/start"
   - –¥–æ—Å—Ç–∞—ë–º telegramId, fullName, chatId
   - –ø—ã—Ç–∞–µ–º—Å—è –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:
       a) –µ—Å–ª–∏ –Ω–æ–≤—ã–π ‚Üí —Å–æ–∑–¥–∞—ë–º User –≤ –ë–î ‚Üí sendWelcomeMessage(..., isNewUser = true)
       b) –µ—Å–ª–∏ —É–∂–µ –µ—Å—Ç—å:
           - –∏—â–µ–º –º–∞–≥–∞–∑–∏–Ω –ø–æ telegramId
           - –µ—Å–ª–∏ –º–∞–≥–∞–∑–∏–Ω –∞–∫—Ç–∏–≤–µ–Ω ‚Üí —Å—Ä–∞–∑—É sendShopMenu(...)
           - –µ—Å–ª–∏ –º–∞–≥–∞–∑–∏–Ω –µ—Å—Ç—å, –Ω–æ –Ω–µ –∞–∫—Ç–∏–≤–µ–Ω ‚Üí —à–ª—ë–º "–∂–¥—ë–º –∞–∫—Ç–∏–≤–∞—Ü–∏–∏"
           - –µ—Å–ª–∏ –º–∞–≥–∞–∑–∏–Ω–∞ –Ω–µ—Ç ‚Üí sendWelcomeMessage(..., isNewUser = false)
   - –µ—Å–ª–∏ –ø—Ä–æ–∏–∑–æ—à–ª–∞ –∂—ë—Å—Ç–∫–∞—è –æ—à–∏–±–∫–∞ ‚Üí sendErrorMessage(...)
```

---

## –ß—Ç–æ –¥–∞–ª—å—à–µ —Ä–∞–∑–±–∏—Ä–∞—Ç—å

–õ–æ–≥–∏—á–Ω–æ –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å –ø—É—Ç—å —Å–æ–±—ã—Ç–∏—è:

- –ø–æ—Å–ª–µ `/start` –∏ inline‚Äë–∫–Ω–æ–ø–æ–∫ "–ú–∞–≥–∞–∑–∏–Ω"/"–ö—É—Ä—å–µ—Ä" –≤—Å—ë –ª–µ—Ç–∏—Ç –≤  
  **`CallbackQueryHandler`**.

–ü–æ—ç—Ç–æ–º—É —Å–ª–µ–¥—É—é—â–∏–º —à–∞–≥–æ–º –≤ `code-explained` –º–æ–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å:

- `07_CallbackQueryHandler.md` ‚Äî —Ç–æ—Ç–∞–ª—å–Ω—ã–π —Ä–∞–∑–±–æ—Ä:
  - —á—Ç–æ —Ç–∞–∫–æ–µ `CallbackQuery`,
  - –æ—Ç–∫—É–¥–∞ —Ç–∞–º `getData()`, `getFrom()`, `getMessage()`,
  - –∫–∞–∫ –æ–Ω —Ä—É–ª–∏—Ç:
    - –≤—ã–±–æ—Ä–æ–º —Ä–æ–ª–∏,
    - —Å–æ–∑–¥–∞–Ω–∏–µ–º –∑–∞–∫–∞–∑–æ–≤,
    - —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ–º/–æ—Ç–º–µ–Ω–æ–π,
    - —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–µ–π –∫—É—Ä—å–µ—Ä–∞.

