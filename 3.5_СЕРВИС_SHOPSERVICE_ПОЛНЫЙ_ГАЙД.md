# üè™ –°–ï–†–í–ò–° SHOPSERVICE ‚Äî –ü–û–õ–ù–´–ô –û–ë–£–ß–ê–Æ–©–ò–ô –ì–ê–ô–î

**–§–∞–π–ª:** `src/main/java/org/example/flower_delivery/service/ShopService.java`

–ë–ª—è—Ç—å, –Ω—É –≤–æ—Ç –º—ã –∏ –¥–æ–±—Ä–∞–ª–∏—Å—å –¥–æ —Å–µ—Ä–≤–∏—Å–Ω–æ–≥–æ —Å–ª–æ—è. –≠—Ç–æ, —Å—É–∫–∞, —Å–∞–º–∞—è –º—è—Å–Ω–∞—è —á–∞—Å—Ç—å ‚Äî —Ç—É—Ç –∂–∏–≤—ë—Ç **–±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞**. –ù–µ –ø—Ä–æ—Å—Ç–æ "–¥–æ—Å—Ç–∞—Ç—å –∏–∑ –ë–î", –∞ "–ø—Ä–æ–≤–µ—Ä–∏—Ç—å, —Å–æ–∑–¥–∞—Ç—å, –≤—ã–µ–±–Ω—É—Ç—å—Å—è –µ—Å–ª–∏ —á—Ç–æ-—Ç–æ –Ω–µ —Ç–∞–∫".

---

## üìã –°–û–î–ï–†–ñ–ê–ù–ò–ï

1. [–ß—Ç–æ —Ç–∞–∫–æ–µ —Å–µ—Ä–≤–∏—Å –∏ –Ω–∞—Ö—É—è –æ–Ω –Ω—É–∂–µ–Ω](#—á—Ç–æ-—Ç–∞–∫–æ–µ-—Å–µ—Ä–≤–∏—Å)
2. [–ê–Ω–Ω–æ—Ç–∞—Ü–∏–∏ –∫–ª–∞—Å—Å–∞ ‚Äî —Ä–∞–∑–±–æ—Ä –ø–æ –±—É–∫–≤–∞–º](#–∞–Ω–Ω–æ—Ç–∞—Ü–∏–∏-–∫–ª–∞—Å—Å–∞)
3. [Dependency Injection ‚Äî –∫–∞–∫ Spring –ø–æ–¥—Å—Ç–∞–≤–ª—è–µ—Ç –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏](#dependency-injection)
4. [–†–∞–∑–±–æ—Ä –∫–∞–∂–¥–æ–≥–æ –º–µ—Ç–æ–¥–∞](#—Ä–∞–∑–±–æ—Ä-–º–µ—Ç–æ–¥–æ–≤)
5. [Optional ‚Äî –µ—â—ë —Ä–∞–∑, –Ω–æ —Å –ø—Ä–∏–º–µ—Ä–∞–º–∏](#optional-–ø–æ–¥—Ä–æ–±–Ω–æ)
6. [orElseThrow –∏ ifPresent ‚Äî –º–∞–≥–∏—è –ª—è–º–±–¥](#orelseerthrow-–∏-ifpresent)
7. [@Transactional ‚Äî —á—Ç–æ —ç—Ç–æ –∑–∞ —Ö—É–π–Ω—è](#transactional)
8. [–ß—Ç–æ –æ—Å—Ç–∞–ª–æ—Å—å –¥–æ –∫–æ–Ω—Ü–∞ –≠—Ç–∞–ø–∞ 2](#—á—Ç–æ-–æ—Å—Ç–∞–ª–æ—Å—å)

---

# –ß–¢–û –¢–ê–ö–û–ï –°–ï–†–í–ò–°

## –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è (—Å–ª–æ–∏)

–ü—Ä–µ–¥—Å—Ç–∞–≤—å —Å–µ–±–µ –±—É—Ä–≥–µ—Ä. –°–ª–æ—ë–Ω—ã–π, –±–ª—è—Ç—å:

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  HANDLER (–æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥ –±–æ—Ç–∞)   ‚îÇ  ‚Üê –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Ç—ã–∫–∞–µ—Ç /register_shop
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ  SERVICE (–±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞)            ‚îÇ  ‚Üê –ü—Ä–æ–≤–µ—Ä–∫–∏, —Å–æ–∑–¥–∞–Ω–∏–µ, –ª–æ–≥–∏–∫–∞
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ  REPOSITORY (–¥–æ—Å—Ç—É–ø –∫ –ë–î)           ‚îÇ  ‚Üê SQL-–∑–∞–ø—Ä–æ—Å—ã (–≥–µ–Ω–µ—Ä–∏—Ç Spring)
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ  DATABASE (PostgreSQL)              ‚îÇ  ‚Üê –¢–∞–±–ª–∏—Ü—ã, –¥–∞–Ω–Ω—ã–µ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

**Handler** ‚Äî –ø—Ä–∏–Ω–∏–º–∞–µ—Ç –∫–æ–º–∞–Ω–¥—É –æ—Ç —é–∑–µ—Ä–∞, –¥—ë—Ä–≥–∞–µ—Ç —Å–µ—Ä–≤–∏—Å.  
**Service** ‚Äî –¥—É–º–∞–µ—Ç: "–∞ –º–æ–∂–Ω–æ –ª–∏ —Å–æ–∑–¥–∞—Ç—å –º–∞–≥–∞–∑–∏–Ω? –∞ –µ—Å—Ç—å –ª–∏ —é–∑–µ—Ä? –∞ –Ω–µ—Ç –ª–∏ —É–∂–µ –º–∞–≥–∞–∑–∏–Ω–∞?"  
**Repository** ‚Äî —Ç—É–ø–æ —Ö–æ–¥–∏—Ç –≤ –ë–î: "–¥–∞–π –º–Ω–µ Shop –ø–æ user_id".  
**Database** ‚Äî —Ö—Ä–∞–Ω–∏—Ç –¥–∞–Ω–Ω—ã–µ.

## –ü–æ—á–µ–º—É –Ω–µ –¥—ë—Ä–≥–∞—Ç—å Repository –Ω–∞–ø—Ä—è–º—É—é –∏–∑ Handler?

**–ú–æ–∂–Ω–æ**, –Ω–æ —ç—Ç–æ –≥–æ–≤–Ω–æ–∫–æ–¥:

1. **–î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –ª–æ–≥–∏–∫–∏** ‚Äî –µ—Å–ª–∏ –≤ –¥–≤—É—Ö –º–µ—Å—Ç–∞—Ö –Ω—É–∂–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ "–µ—Å—Ç—å –ª–∏ —É–∂–µ –º–∞–≥–∞–∑–∏–Ω", —Ç—ã –±—É–¥–µ—à—å –∫–æ–ø–∏–ø–∞—Å—Ç–∏—Ç—å –∫–æ–¥.
2. **–ù–µ—Ç –µ–¥–∏–Ω–æ–π —Ç–æ—á–∫–∏** ‚Äî –∑–∞–≤—Ç—Ä–∞ —Ç–µ–±–µ —Å–∫–∞–∂—É—Ç "–ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –º–∞–≥–∞–∑–∏–Ω–∞ –æ—Ç–ø—Ä–∞–≤–ª—è–π —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –∞–¥–º–∏–Ω—É". –ö—É–¥–∞ –≤—Å—Ç–∞–≤–∏—à—å? –í –∫–∞–∂–¥—ã–π —Ö–µ–Ω–¥–ª–µ—Ä?
3. **–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ** ‚Äî —Å–µ—Ä–≤–∏—Å –º–æ–∂–Ω–æ –∑–∞–º–æ–∫–∞—Ç—å –∏ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –æ—Ç–¥–µ–ª—å–Ω–æ.

**Service = –µ–¥–∏–Ω–∞—è —Ç–æ—á–∫–∞ –≤—Ö–æ–¥–∞ –¥–ª—è –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∏.**

–•–µ–Ω–¥–ª–µ—Ä –Ω–µ –∑–Ω–∞–µ—Ç, –∫–∞–∫ —Å–æ–∑–¥–∞—Ç—å –º–∞–≥–∞–∑–∏–Ω. –û–Ω –ø—Ä–æ—Å—Ç–æ –≥–æ–≤–æ—Ä–∏—Ç: "–≠–π, ShopService, —Å–æ–∑–¥–∞–π –º–∞–≥–∞–∑–∏–Ω –≤–æ—Ç —Å —Ç–∞–∫–∏–º–∏ –¥–∞–Ω–Ω—ã–º–∏". –°–µ—Ä–≤–∏—Å –¥–µ–ª–∞–µ—Ç –≤—Å—é –≥—Ä—è–∑–Ω—É—é —Ä–∞–±–æ—Ç—É.

---

# –ê–ù–ù–û–¢–ê–¶–ò–ò –ö–õ–ê–°–°–ê

```java
@Service
@RequiredArgsConstructor
@Slf4j
@Transactional
public class ShopService {
```

–†–∞–∑–±–∏—Ä–∞–µ–º –∫–∞–∂–¥—É—é, —Å—É–∫–∞, –ø–æ –±—É–∫–≤–∞–º.

---

## @Service

**–ü–∞–∫–µ—Ç:** `org.springframework.stereotype.Service`

**–ß—Ç–æ –¥–µ–ª–∞–µ—Ç:**
- –ì–æ–≤–æ—Ä–∏—Ç Spring: "–≠—Ç–æ —Å–µ—Ä–≤–∏—Å–Ω—ã–π –±–∏–Ω, —Å–æ–∑–¥–∞–π –µ–≥–æ –∏ –ø–æ–ª–æ–∂–∏ –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä".
- –¢–µ–ø–µ—Ä—å –º–æ–∂–Ω–æ –∏–Ω–∂–µ–∫—Ç–∏—Ç—å `ShopService` –≤ –ª—é–±–æ–µ –º–µ—Å—Ç–æ —á–µ—Ä–µ–∑ `@Autowired` –∏–ª–∏ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä.

**–ß–µ–º –æ—Ç–ª–∏—á–∞–µ—Ç—Å—è –æ—Ç @Component:**
- –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏ ‚Äî **–Ω–∏—á–µ–º**. –≠—Ç–æ –ø—Ä–æ—Å—Ç–æ `@Component` —Å –¥—Ä—É–≥–∏–º –∏–º–µ–Ω–µ–º.
- –°–µ–º–∞–Ω—Ç–∏—á–µ—Å–∫–∏ ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç, —á—Ç–æ —ç—Ç–æ **—Å–µ—Ä–≤–∏—Å–Ω—ã–π —Å–ª–æ–π** (–±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞), –∞ –Ω–µ –∫–∞–∫–æ–π-—Ç–æ —Ä–∞–Ω–¥–æ–º–Ω—ã–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç.

**–ê–Ω–∞–ª–æ–≥–∏—è:**
- `@Controller` ‚Äî –¥–ª—è HTTP-–∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–æ–≤ (–æ–±—Ä–∞–±–æ—Ç–∫–∞ –≤–µ–±-–∑–∞–ø—Ä–æ—Å–æ–≤).
- `@Service` ‚Äî –¥–ª—è –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∏.
- `@Repository` ‚Äî –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ –¥–∞–Ω–Ω—ã–º.
- `@Component` ‚Äî –¥–ª—è –≤—Å–µ–≥–æ –æ—Å—Ç–∞–ª—å–Ω–æ–≥–æ.

–í—Å–µ –æ–Ω–∏ –¥–µ–ª–∞—é—Ç –æ–¥–Ω–æ –∏ —Ç–æ –∂–µ (—Å–æ–∑–¥–∞—é—Ç –±–∏–Ω), –Ω–æ –ø–æ –∏–º–µ–Ω–∏ —Å—Ä–∞–∑—É –≤–∏–¥–Ω–æ, —á—Ç–æ –∑–∞ —Ö—É–π–Ω—è –ø–µ—Ä–µ–¥ —Ç–æ–±–æ–π.

---

## @RequiredArgsConstructor

**–ü–∞–∫–µ—Ç:** Lombok

**–ß—Ç–æ –¥–µ–ª–∞–µ—Ç:**
- –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä —Å–æ –≤—Å–µ–º–∏ `final` –ø–æ–ª—è–º–∏.

–£ –Ω–∞—Å:

```java
private final ShopRepository shopRepository;
private final UserRepository userRepository;
```

Lombok —Å–≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç:

```java
public ShopService(ShopRepository shopRepository, UserRepository userRepository) {
    this.shopRepository = shopRepository;
    this.userRepository = userRepository;
}
```

**–ó–∞—á–µ–º:**
- –ù–µ –ø–∏—Å–∞—Ç—å –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä —Ä—É–∫–∞–º–∏.
- Spring –≤–∏–¥–∏—Ç –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏ ‚Üí –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∏–Ω–∂–µ–∫—Ç–∏—Ç –±–∏–Ω—ã `ShopRepository` –∏ `UserRepository`.

**–ü–æ—á–µ–º—É `final`:**
- –ü–æ–ª—è –ø–æ–º–µ—á–µ–Ω—ã `final` = –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É—é—Ç—Å—è –≤ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä–µ.
- –ù–µ–ª—å–∑—è —Å–ª—É—á–∞–π–Ω–æ –ø–µ—Ä–µ–∑–∞–ø–∏—Å–∞—Ç—å (–∑–∞—â–∏—Ç–∞ –æ—Ç –¥—É—Ä–∞–∫–∞).
- Lombok –≥–µ–Ω–µ—Ä–∏—Ç –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä —Ç–æ–ª—å–∫–æ –¥–ª—è `final` –ø–æ–ª–µ–π (–∏ –¥–ª—è `@NonNull`, –Ω–æ —ç—Ç–æ –¥—Ä—É–≥–∞—è –∏—Å—Ç–æ—Ä–∏—è).

---

## @Slf4j

**–ü–∞–∫–µ—Ç:** Lombok

**–ß—Ç–æ –¥–µ–ª–∞–µ—Ç:**
- –°–æ–∑–¥–∞—ë—Ç –ø–æ–ª–µ `log` –¥–ª—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è.

–≠–∫–≤–∏–≤–∞–ª–µ–Ω—Ç:

```java
private static final Logger log = LoggerFactory.getLogger(ShopService.class);
```

**–ó–∞—á–µ–º:**
- –õ–æ–≥–∏—Ä–æ–≤–∞—Ç—å, –±–ª—è—Ç—å! –ß—Ç–æ–±—ã –≤ –∫–æ–Ω—Å–æ–ª–∏ –≤–∏–¥–µ—Ç—å: "–°–æ–∑–¥–∞–Ω–∏–µ –º–∞–≥–∞–∑–∏–Ω–∞: telegramId=123, shopName=–¶–≤–µ—Ç—ã".
- –ö–æ–≥–¥–∞ —á—Ç–æ-—Ç–æ —Å–ª–æ–º–∞–µ—Ç—Å—è ‚Äî —Å–º–æ—Ç—Ä–∏—à—å –ª–æ–≥–∏ –∏ –ø–æ–Ω–∏–º–∞–µ—à—å, –≥–¥–µ –ø–∏–∑–¥–µ—Ü —Å–ª—É—á–∏–ª—Å—è.

**–£—Ä–æ–≤–Ω–∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è:**
- `log.trace("...")` ‚Äî —Å–∞–º—ã–π –¥–µ—Ç–∞–ª—å–Ω—ã–π (–æ–±—ã—á–Ω–æ –æ—Ç–∫–ª—é—á—ë–Ω).
- `log.debug("...")` ‚Äî –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ (–æ—Ç–ª–∞–¥–∫–∞).
- `log.info("...")` ‚Äî –≤–∞–∂–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è (—Å–æ–∑–¥–∞–Ω –º–∞–≥–∞–∑–∏–Ω, –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞—Ä–µ–≥–∞–ª—Å—è).
- `log.warn("...")` ‚Äî –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è (—á—Ç–æ-—Ç–æ –ø–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω–æ–µ).
- `log.error("...")` ‚Äî –æ—à–∏–±–∫–∏ (–ø–∏–∑–¥–µ—Ü —Å–ª—É—á–∏–ª—Å—è).

–í `application.properties` –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º —É—Ä–æ–≤–µ–Ω—å:

```properties
logging.level.org.example.flower_delivery=DEBUG
```

---

## @Transactional

**–ü–∞–∫–µ—Ç:** `org.springframework.transaction.annotation.Transactional`

**–ß—Ç–æ –¥–µ–ª–∞–µ—Ç:**
- –û–±–æ—Ä–∞—á–∏–≤–∞–µ—Ç –º–µ—Ç–æ–¥—ã –∫–ª–∞—Å—Å–∞ –≤ **—Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é –ë–î**.

**–ß—Ç–æ —Ç–∞–∫–æ–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è:**

–ü—Ä–µ–¥—Å—Ç–∞–≤—å, —Ç—ã –ø–µ—Ä–µ–≤–æ–¥–∏—à—å –¥–µ–Ω—å–≥–∏:
1. –°–ø–∏—Å–∞—Ç—å 1000‚ÇΩ —Å–æ —Å—á—ë—Ç–∞ –ê.
2. –ó–∞—á–∏—Å–ª–∏—Ç—å 1000‚ÇΩ –Ω–∞ —Å—á—ë—Ç –ë.

–ï—Å–ª–∏ —à–∞–≥ 1 –≤—ã–ø–æ–ª–Ω–∏–ª—Å—è, –∞ —à–∞–≥ 2 —É–ø–∞–ª (–æ—à–∏–±–∫–∞, —Å–µ—Ä–≤–µ—Ä —Å–¥–æ—Ö) ‚Äî –¥–µ–Ω—å–≥–∏ –∏—Å—á–µ–∑–ª–∏. –≠—Ç–æ –ø–∏–∑–¥–µ—Ü.

**–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è** –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç: –ª–∏–±–æ **–æ–±–∞** —à–∞–≥–∞ –≤—ã–ø–æ–ª–Ω—è—Ç—Å—è, –ª–∏–±–æ **–Ω–∏ –æ–¥–∏–Ω** (–æ—Ç–∫–∞—Ç).

–í –Ω–∞—à–µ–º —Å–ª—É—á–∞–µ:
- `createShopForUser()` –¥–µ–ª–∞–µ—Ç `shopRepository.save(shop)`.
- –ï—Å–ª–∏ –ø–æ—Å–ª–µ `save()` —á—Ç–æ-—Ç–æ —É–ø–∞–¥—ë—Ç ‚Äî —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –æ—Ç–∫–∞—Ç–∏—Ç—Å—è, –º–∞–≥–∞–∑–∏–Ω –Ω–µ —Å–æ–∑–¥–∞—Å—Ç—Å—è.

**@Transactional –Ω–∞ –∫–ª–∞—Å—Å–µ** ‚Äî –≤—Å–µ –ø—É–±–ª–∏—á–Ω—ã–µ –º–µ—Ç–æ–¥—ã –∫–ª–∞—Å—Å–∞ –±—É–¥—É—Ç —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–æ–Ω–Ω—ã–º–∏.

**–ö–æ–≥–¥–∞ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –Ω—É–∂–Ω–∞:**
- –ù–µ—Å–∫–æ–ª—å–∫–æ –æ–ø–µ—Ä–∞—Ü–∏–π —Å –ë–î, –∫–æ—Ç–æ—Ä—ã–µ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –∞—Ç–æ–º–∞—Ä–Ω—ã–º–∏ (–≤—Å—ë –∏–ª–∏ –Ω–∏—á–µ–≥–æ).
- –ß—Ç–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö, –∫–æ—Ç–æ—Ä—ã–µ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –∫–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω—ã–º–∏ (–Ω–µ –∏–∑–º–µ–Ω–∏–ª–∏—Å—å –ø–æ—Å–µ—Ä–µ–¥–∏–Ω–µ).

**–ö–æ–≥–¥–∞ –º–æ–∂–Ω–æ –±–µ–∑ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏:**
- –û–¥–∏–Ω `findBy...()` –∑–∞–ø—Ä–æ—Å ‚Äî —Ç—É—Ç –∏ —Ç–∞–∫ –≤—Å—ë –æ–∫.

–ù–æ –ø—Ä–æ—â–µ –ø–æ–≤–µ—Å–∏—Ç—å `@Transactional` –Ω–∞ –≤–µ—Å—å —Å–µ—Ä–≤–∏—Å –∏ –Ω–µ –µ–±–∞—Ç—å —Å–µ–±–µ –º–æ–∑–≥–∏.

---

# DEPENDENCY INJECTION

```java
private final ShopRepository shopRepository;
private final UserRepository userRepository;
```

**Dependency Injection (DI)** ‚Äî Spring —Å–∞–º —Å–æ–∑–¥–∞—ë—Ç –∏ –ø–æ–¥—Å—Ç–∞–≤–ª—è–µ—Ç –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏.

## –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç:

1. Spring —Å—Ç–∞—Ä—Ç—É–µ—Ç ‚Üí –≤–∏–¥–∏—Ç `@Service` –Ω–∞ `ShopService`.
2. –°–º–æ—Ç—Ä–∏—Ç –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä: "–ê–≥–∞, –Ω—É–∂–Ω—ã `ShopRepository` –∏ `UserRepository`".
3. –ò—â–µ—Ç –±–∏–Ω—ã —Å —Ç–∞–∫–∏–º–∏ —Ç–∏–ø–∞–º–∏ –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ.
4. –ù–∞—Ö–æ–¥–∏—Ç (–æ–Ω–∏ –ø–æ–º–µ—á–µ–Ω—ã `@Repository`).
5. –°–æ–∑–¥–∞—ë—Ç `ShopService`, –ø–µ—Ä–µ–¥–∞–≤–∞—è –≤ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏.

**–ë–µ–∑ DI —Ç—ã –±—ã –ø–∏—Å–∞–ª:**

```java
ShopRepository shopRepository = new ShopRepositoryImpl(entityManager);
UserRepository userRepository = new UserRepositoryImpl(entityManager);
ShopService shopService = new ShopService(shopRepository, userRepository);
```

–ò —Ç–∞–∫ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Å–µ—Ä–≤–∏—Å–∞, –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–∞, —Ö–µ–Ω–¥–ª–µ—Ä–∞. –ï–±–∞–Ω—É—Ç—å—Å—è –º–æ–∂–Ω–æ.

**–° DI:**
- –û–±—ä—è–≤–∏–ª –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å.
- Spring –ø–æ–¥—Å—Ç–∞–≤–∏–ª.
- Profit.

---

# –†–ê–ó–ë–û–† –ú–ï–¢–û–î–û–í

## –ú–µ—Ç–æ–¥ findByUser

```java
public Optional<Shop> findByUser(User user) {
    log.debug("–ü–æ–∏—Å–∫ –º–∞–≥–∞–∑–∏–Ω–∞ –ø–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é: userId={}", user.getId());
    return shopRepository.findByUser(user);
}
```

**–ß—Ç–æ –¥–µ–ª–∞–µ—Ç:**
- –õ–æ–≥–∏—Ä—É–µ—Ç –∑–∞–ø—Ä–æ—Å (debug —É—Ä–æ–≤–µ–Ω—å ‚Äî —Ç–æ–ª—å–∫–æ –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏).
- –í—ã–∑—ã–≤–∞–µ—Ç —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π.
- –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç `Optional<Shop>` ‚Äî –º–æ–∂–µ—Ç –±—ã—Ç—å –º–∞–≥–∞–∑–∏–Ω, –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç–æ.

**–ó–∞—á–µ–º –º–µ—Ç–æ–¥-–æ–±—ë—Ä—Ç–∫–∞:**
- –°–µ–π—á–∞—Å ‚Äî –ø—Ä–æ—Å—Ç–æ –ø—Ä–æ–∫—Å–∏.
- –ó–∞–≤—Ç—Ä–∞ ‚Äî –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ, –ª–æ–≥–∏–∫—É, –ø—Ä–æ–≤–µ—Ä–∫–∏.
- –ï–¥–∏–Ω–∞—è —Ç–æ—á–∫–∞ –¥–æ—Å—Ç—É–ø–∞.

---

## –ú–µ—Ç–æ–¥ findByUserId

```java
public Optional<Shop> findByUserId(UUID userId) {
    log.debug("–ü–æ–∏—Å–∫ –º–∞–≥–∞–∑–∏–Ω–∞ –ø–æ userId={}", userId);
    return shopRepository.findByUserId(userId);
}
```

**–¢–æ –∂–µ —Å–∞–º–æ–µ**, —Ç–æ–ª—å–∫–æ –ø–∞—Ä–∞–º–µ—Ç—Ä ‚Äî `UUID userId`, –∞ –Ω–µ –æ–±—ä–µ–∫—Ç `User`.

**–ö–æ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å:**
- –ö–æ–≥–¥–∞ —É —Ç–µ–±—è –µ—Å—Ç—å —Ç–æ–ª—å–∫–æ `userId` (–Ω–∞–ø—Ä–∏–º–µ—Ä, –∏–∑ –∫–∞–∫–æ–≥–æ-—Ç–æ DTO –∏–ª–∏ –∑–∞–ø—Ä–æ—Å–∞).

---

## –ú–µ—Ç–æ–¥ findByUserTelegramId

```java
public Optional<Shop> findByUserTelegramId(Long telegramId) {
    log.debug("–ü–æ–∏—Å–∫ –º–∞–≥–∞–∑–∏–Ω–∞ –ø–æ telegramId={}", telegramId);
    return shopRepository.findByUserTelegramId(telegramId);
}
```

**–°–∞–º—ã–π —á–∞—Å—Ç—ã–π –∫–µ–π—Å –≤ –±–æ—Ç–µ:**
- –ü—Ä–∏—à–ª–æ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
- –ò–∑ `update.getMessage().getFrom().getId()` –ø–æ–ª—É—á–∞–µ–º `telegramId`.
- –ò—â–µ–º –º–∞–≥–∞–∑–∏–Ω –ø–æ —ç—Ç–æ–º—É `telegramId`.

---

## –ú–µ—Ç–æ–¥ createShopForUser (–ú–Ø–°–û!)

```java
public Shop createShopForUser(Long telegramId,
                              String shopName,
                              String pickupAddress,
                              String phone) {

    log.info("–°–æ–∑–¥–∞–Ω–∏–µ –º–∞–≥–∞–∑–∏–Ω–∞: telegramId={}, shopName={}", telegramId, shopName);

    // 1. –ù–∞—Ö–æ–¥–∏–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ telegramId
    User user = userRepository.findByTelegramId(telegramId)
            .orElseThrow(() -> new IllegalStateException("–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω –¥–ª—è telegramId=" + telegramId));

    // 2. –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —É –Ω–µ–≥–æ –µ—â—ë –Ω–µ—Ç –º–∞–≥–∞–∑–∏–Ω–∞
    shopRepository.findByUser(user).ifPresent(existing -> {
        throw new IllegalStateException("–£ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —É–∂–µ –µ—Å—Ç—å –º–∞–≥–∞–∑–∏–Ω");
    });

    // 3. –°–æ–±–∏—Ä–∞–µ–º —Å—É—â–Ω–æ—Å—Ç—å Shop
    Shop shop = Shop.builder()
            .user(user)
            .shopName(shopName)
            .pickupAddress(pickupAddress)
            .phone(phone)
            .isActive(false)
            .build();

    // 4. –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –ë–î
    Shop saved = shopRepository.save(shop);
    log.info("–ú–∞–≥–∞–∑–∏–Ω —Å–æ–∑–¥–∞–Ω: shopId={}, userId={}", saved.getId(), user.getId());

    return saved;
}
```

–≠—Ç–æ **–≥–ª–∞–≤–Ω—ã–π –º–µ—Ç–æ–¥** ‚Äî —Å–æ–∑–¥–∞–Ω–∏–µ –º–∞–≥–∞–∑–∏–Ω–∞. –†–∞–∑–±–µ—Ä—ë–º –ø–æ —à–∞–≥–∞–º.

---

### –®–∞–≥ 1: –ù–∞—Ö–æ–¥–∏–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

```java
User user = userRepository.findByTelegramId(telegramId)
        .orElseThrow(() -> new IllegalStateException("–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω..."));
```

**–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç:**
1. `findByTelegramId(telegramId)` –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç `Optional<User>`.
2. `.orElseThrow(...)` ‚Äî –µ—Å–ª–∏ `Optional` –ø—É—Å—Ç–æ–π, –∫–∏–¥–∞–µ–º –∏—Å–∫–ª—é—á–µ–Ω–∏–µ.
3. –ï—Å–ª–∏ —é–∑–µ—Ä –µ—Å—Ç—å ‚Äî –ø–æ–ª—É—á–∞–µ–º –µ–≥–æ –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é `user`.

**–ü–æ—á–µ–º—É `orElseThrow`:**
- –ù–µ–ª—å–∑—è —Å–æ–∑–¥–∞—Ç—å –º–∞–≥–∞–∑–∏–Ω –¥–ª—è –Ω–µ—Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
- –ï—Å–ª–∏ —é–∑–µ—Ä–∞ –Ω–µ—Ç ‚Äî —ç—Ç–æ –±–∞–≥ –∏–ª–∏ –∞—Ç–∞–∫–∞ (–∫—Ç–æ-—Ç–æ –ø—ã—Ç–∞–µ—Ç—Å—è —Å–æ–∑–¥–∞—Ç—å –º–∞–≥–∞–∑–∏–Ω –±–µ–∑ `/start`).
- –ö–∏–¥–∞–µ–º –∏—Å–∫–ª—é—á–µ–Ω–∏–µ ‚Üí —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –æ—Ç–∫–∞—Ç–∏—Ç—Å—è ‚Üí –º–∞–≥–∞–∑–∏–Ω –Ω–µ —Å–æ–∑–¥–∞—Å—Ç—Å—è.

**–õ—è–º–±–¥–∞ `() -> new IllegalStateException(...)`:**
- –≠—Ç–æ **Supplier** ‚Äî —Ñ—É–Ω–∫—Ü–∏—è –±–µ–∑ –∞—Ä–≥—É–º–µ–Ω—Ç–æ–≤, –∫–æ—Ç–æ—Ä–∞—è –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∏—Å–∫–ª—é—á–µ–Ω–∏–µ.
- –í—ã–∑—ã–≤–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ `Optional` –ø—É—Å—Ç–æ–π (–ª–µ–Ω–∏–≤–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ –∏—Å–∫–ª—é—á–µ–Ω–∏—è).

---

### –®–∞–≥ 2: –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ—Ç –ª–∏ —É–∂–µ –º–∞–≥–∞–∑–∏–Ω–∞

```java
shopRepository.findByUser(user).ifPresent(existing -> {
    throw new IllegalStateException("–£ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —É–∂–µ –µ—Å—Ç—å –º–∞–≥–∞–∑–∏–Ω");
});
```

**–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç:**
1. –ò—â–µ–º –º–∞–≥–∞–∑–∏–Ω –¥–ª—è —ç—Ç–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
2. `ifPresent(...)` ‚Äî –µ—Å–ª–∏ –Ω–∞—à–ª–∏, –≤—ã–ø–æ–ª–Ω—è–µ–º –ª—è–º–±–¥—É.
3. –õ—è–º–±–¥–∞ `existing -> { throw ... }` ‚Äî –∫–∏–¥–∞–µ–º –∏—Å–∫–ª—é—á–µ–Ω–∏–µ.

**–ü–æ—á–µ–º—É —Ç–∞–∫:**
- –û–¥–∏–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å = –æ–¥–∏–Ω –º–∞–≥–∞–∑–∏–Ω (1:1 —Å–≤—è–∑—å, UNIQUE constraint –≤ –ë–î).
- –ï—Å–ª–∏ —É —é–∑–µ—Ä–∞ —É–∂–µ –µ—Å—Ç—å –º–∞–≥–∞–∑–∏–Ω ‚Äî –Ω–µ–ª—å–∑—è —Å–æ–∑–¥–∞—Ç—å –≤—Ç–æ—Ä–æ–π.
- –õ—É—á—à–µ –∫–∏–Ω—É—Ç—å –∏—Å–∫–ª—é—á–µ–Ω–∏–µ —Å –ø–æ–Ω—è—Ç–Ω—ã–º —Å–æ–æ–±—â–µ–Ω–∏–µ–º, —á–µ–º –ø–æ–ª—É—á–∏—Ç—å `UNIQUE constraint violation` –æ—Ç –ë–î.

**–ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π —Å–ø–æ—Å–æ–± (—ç–∫–≤–∏–≤–∞–ª–µ–Ω—Ç):**

```java
Optional<Shop> existingShop = shopRepository.findByUser(user);
if (existingShop.isPresent()) {
    throw new IllegalStateException("–£ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —É–∂–µ –µ—Å—Ç—å –º–∞–≥–∞–∑–∏–Ω");
}
```

–ù–æ `ifPresent` ‚Äî –∫–æ—Ä–æ—á–µ –∏ –∏–¥–∏–æ–º–∞—Ç–∏—á–Ω–µ–µ.

---

### –®–∞–≥ 3: –°–æ–±–∏—Ä–∞–µ–º —Å—É—â–Ω–æ—Å—Ç—å Shop

```java
Shop shop = Shop.builder()
        .user(user)
        .shopName(shopName)
        .pickupAddress(pickupAddress)
        .phone(phone)
        .isActive(false)
        .build();
```

**Builder-–ø–∞—Ç—Ç–µ—Ä–Ω:**
- –¶–µ–ø–æ—á–∫–∞ `.user(...).shopName(...)...build()`.
- –£–¥–æ–±–Ω–æ —Å–æ–∑–¥–∞–≤–∞—Ç—å –æ–±—ä–µ–∫—Ç, –Ω–µ –∑–∞–ø–æ–ª–Ω—è—è –≤—Å–µ 100500 –ø–æ–ª–µ–π.
- `@Builder` –≤ –∫–ª–∞—Å—Å–µ `Shop` –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —ç—Ç–æ—Ç –±–∏–ª–¥–µ—Ä.

**–ß—Ç–æ –ù–ï —É–∫–∞–∑—ã–≤–∞–µ–º:**
- `id` ‚Äî —Å–≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è –≤ –ë–î (`@GeneratedValue`).
- `latitude`, `longitude` ‚Äî –ø–æ–∫–∞ null (–≥–µ–æ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏–µ –±—É–¥–µ—Ç –ø–æ—Ç–æ–º).
- `createdAt`, `updatedAt` ‚Äî –∑–∞–ø–æ–ª–Ω—è—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ (`@CreationTimestamp`, `@UpdateTimestamp`).
- `isActive = false` ‚Äî –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –º–∞–≥–∞–∑–∏–Ω –Ω–µ–∞–∫—Ç–∏–≤–µ–Ω, –∞–¥–º–∏–Ω –∞–∫—Ç–∏–≤–∏—Ä—É–µ—Ç.

---

### –®–∞–≥ 4: –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –ë–î

```java
Shop saved = shopRepository.save(shop);
log.info("–ú–∞–≥–∞–∑–∏–Ω —Å–æ–∑–¥–∞–Ω: shopId={}, userId={}", saved.getId(), user.getId());
return saved;
```

**`save(shop)`:**
- Hibernate –≤–∏–¥–∏—Ç, —á—Ç–æ `shop.id == null` ‚Üí –¥–µ–ª–∞–µ—Ç `INSERT`.
- –ü–æ—Å–ª–µ `INSERT` Hibernate –∑–∞–ø–æ–ª–Ω—è–µ—Ç `id`, `createdAt`, `updatedAt` –∏–∑ –ë–î.
- –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—É—é —Å—É—â–Ω–æ—Å—Ç—å —Å –∑–∞–ø–æ–ª–Ω–µ–Ω–Ω—ã–º–∏ –ø–æ–ª—è–º–∏.

**–ü–æ—á–µ–º—É `Shop saved = ...`, –∞ –Ω–µ –ø—Ä–æ—Å—Ç–æ `shopRepository.save(shop)`:**
- –ü–æ—Å–ª–µ `save()` —É –æ–±—ä–µ–∫—Ç–∞ –∑–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è `id` (—Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ë–î).
- –ú—ã —Ö–æ—Ç–∏–º –∑–∞–ª–æ–≥–∏—Ä–æ–≤–∞—Ç—å —ç—Ç–æ—Ç `id` –∏ –≤–µ—Ä–Ω—É—Ç—å —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–π –æ–±—ä–µ–∫—Ç.

---

# OPTIONAL –ü–û–î–†–û–ë–ù–û

`Optional<T>` ‚Äî –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä, –∫–æ—Ç–æ—Ä—ã–π –º–æ–∂–µ—Ç —Å–æ–¥–µ—Ä–∂–∞—Ç—å –∑–Ω–∞—á–µ–Ω–∏–µ –∏–ª–∏ –±—ã—Ç—å –ø—É—Å—Ç—ã–º.

## –ó–∞—á–µ–º –ø—Ä–∏–¥—É–º–∞–ª–∏:

**–ü—Ä–æ–±–ª–µ–º–∞ —Å `null`:**

```java
User user = userRepository.findByTelegramId(telegramId); // –º–æ–∂–µ—Ç –≤–µ—Ä–Ω—É—Ç—å null
String name = user.getFullName(); // NullPointerException –µ—Å–ª–∏ user == null
```

**–° Optional:**

```java
Optional<User> userOpt = userRepository.findByTelegramId(telegramId);
if (userOpt.isPresent()) {
    User user = userOpt.get();
    String name = user.getFullName(); // –±–µ–∑–æ–ø–∞—Å–Ω–æ
}
```

–ö–æ–¥ **—è–≤–Ω–æ** –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç: "—Ç—É—Ç –º–æ–∂–µ—Ç –Ω–µ –±—ã—Ç—å –∑–Ω–∞—á–µ–Ω–∏—è, –æ–±—Ä–∞–±–æ—Ç–∞–π —ç—Ç–æ—Ç —Å–ª—É—á–∞–π".

## –û—Å–Ω–æ–≤–Ω—ã–µ –º–µ—Ç–æ–¥—ã Optional:

| –ú–µ—Ç–æ–¥ | –ß—Ç–æ –¥–µ–ª–∞–µ—Ç | –ü—Ä–∏–º–µ—Ä |
|-------|-----------|--------|
| `isPresent()` | –ï—Å—Ç—å –ª–∏ –∑–Ω–∞—á–µ–Ω–∏–µ? | `if (opt.isPresent()) {...}` |
| `isEmpty()` | –ü—É—Å—Ç–æ –ª–∏? (Java 11+) | `if (opt.isEmpty()) {...}` |
| `get()` | –î–æ—Å—Ç–∞—Ç—å –∑–Ω–∞—á–µ–Ω–∏–µ (–æ–ø–∞—Å–Ω–æ!) | `T value = opt.get()` |
| `orElse(T other)` | –ó–Ω–∞—á–µ–Ω–∏–µ –∏–ª–∏ –¥–µ—Ñ–æ–ª—Ç | `T value = opt.orElse(defaultValue)` |
| `orElseThrow()` | –ó–Ω–∞—á–µ–Ω–∏–µ –∏–ª–∏ –∏—Å–∫–ª—é—á–µ–Ω–∏–µ | `T value = opt.orElseThrow()` |
| `orElseThrow(Supplier)` | –ó–Ω–∞—á–µ–Ω–∏–µ –∏–ª–∏ —Å–≤–æ—ë –∏—Å–∫–ª—é—á–µ–Ω–∏–µ | `opt.orElseThrow(() -> new MyException())` |
| `ifPresent(Consumer)` | –í—ã–ø–æ–ª–Ω–∏—Ç—å, –µ—Å–ª–∏ –µ—Å—Ç—å | `opt.ifPresent(v -> doSomething(v))` |
| `map(Function)` | –ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞—Ç—å –∑–Ω–∞—á–µ–Ω–∏–µ | `opt.map(User::getFullName)` |

## –ü—Ä–∏–º–µ—Ä—ã –∏–∑ –∂–∏–∑–Ω–∏:

```java
// –ù–∞–π—Ç–∏ –∏–ª–∏ –∫–∏–Ω—É—Ç—å
User user = userRepository.findByTelegramId(id)
        .orElseThrow(() -> new UserNotFoundException("User not found"));

// –ù–∞–π—Ç–∏ –∏–ª–∏ –≤–µ—Ä–Ω—É—Ç—å null (–µ—Å–ª–∏ –Ω–∞–¥–æ)
User user = userRepository.findByTelegramId(id).orElse(null);

// –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∏ –≤—ã–ø–æ–ª–Ω–∏—Ç—å
shopRepository.findByUser(user).ifPresent(shop -> {
    log.info("–ú–∞–≥–∞–∑–∏–Ω –Ω–∞–π–¥–µ–Ω: {}", shop.getShopName());
});

// –ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞—Ç—å
Optional<String> shopName = shopRepository.findByUser(user)
        .map(Shop::getShopName);
```

---

# @TRANSACTIONAL –ü–û–î–†–û–ë–ù–û

```java
@Transactional
public class ShopService {
```

**–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è** ‚Äî –Ω–∞–±–æ—Ä –æ–ø–µ—Ä–∞—Ü–∏–π, –∫–æ—Ç–æ—Ä—ã–µ –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è **–∞—Ç–æ–º–∞—Ä–Ω–æ**:
- –õ–∏–±–æ –≤—Å–µ —É—Å–ø–µ—à–Ω–æ ‚Üí **commit** (—Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è).
- –õ–∏–±–æ —á—Ç–æ-—Ç–æ —É–ø–∞–ª–æ ‚Üí **rollback** (–æ—Ç–∫–∞—Ç–∏—Ç—å –≤—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è).

## –ü—Ä–∏–º–µ—Ä –±–µ–∑ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ (–ø–ª–æ—Ö–æ):

```java
public void transferMoney(Account from, Account to, int amount) {
    from.setBalance(from.getBalance() - amount);
    accountRepository.save(from);  // –°–æ—Ö—Ä–∞–Ω–∏–ª–∏
    
    // –ë–ê–¶! –¢—É—Ç —Å–µ—Ä–≤–µ—Ä —É–ø–∞–ª
    
    to.setBalance(to.getBalance() + amount);
    accountRepository.save(to);  // –ù–µ –≤—ã–ø–æ–ª–Ω–∏–ª–æ—Å—å
}
// –†–µ–∑—É–ª—å—Ç–∞—Ç: –¥–µ–Ω—å–≥–∏ —Å–ø–∏—Å–∞–ª–∏—Å—å, –Ω–æ –Ω–µ –∑–∞—á–∏—Å–ª–∏–ª–∏—Å—å. –ü–∏–∑–¥–µ—Ü.
```

## –° —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–µ–π (—Ö–æ—Ä–æ—à–æ):

```java
@Transactional
public void transferMoney(Account from, Account to, int amount) {
    from.setBalance(from.getBalance() - amount);
    accountRepository.save(from);
    
    // –ë–ê–¶! –¢—É—Ç —Å–µ—Ä–≤–µ—Ä —É–ø–∞–ª
    
    to.setBalance(to.getBalance() + amount);
    accountRepository.save(to);
}
// –†–µ–∑—É–ª—å—Ç–∞—Ç: —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –æ—Ç–∫–∞—Ç–∏–ª–∞—Å—å, –æ–±–∞ —Å—á—ë—Ç–∞ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π. –ù–æ—Ä–º.
```

## –ö–æ–≥–¥–∞ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç commit/rollback:

- **Commit** ‚Äî –∫–æ–≥–¥–∞ –º–µ—Ç–æ–¥ —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–∏–ª—Å—è (return).
- **Rollback** ‚Äî –∫–æ–≥–¥–∞ –º–µ—Ç–æ–¥ –∫–∏–Ω—É–ª **unchecked exception** (RuntimeException –∏ –Ω–∞—Å–ª–µ–¥–Ω–∏–∫–∏).

–ï—Å–ª–∏ –∫–∏–Ω—É—Ç—å `checked exception` (–Ω–∞–ø—Ä–∏–º–µ—Ä, `IOException`) ‚Äî –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é **–ù–ï –æ—Ç–∫–∞—Ç–∏—Ç—Å—è**. –ù–æ —ç—Ç–æ —Ä–µ–¥–∫–∏–π –∫–µ–π—Å.

---

# –ß–¢–û –û–°–¢–ê–õ–û–°–¨ –î–û –ö–û–ù–¶–ê –≠–¢–ê–ü–ê 2

–≠—Ç–∞–ø 2 –ø–æ –ø–ª–∞–Ω—É –≤–∫–ª—é—á–∞–µ—Ç:

## ‚úÖ –°–î–ï–õ–ê–ù–û:

1. ‚úÖ –ú–∏–≥—Ä–∞—Ü–∏—è V2 ‚Äî —Ç–∞–±–ª–∏—Ü–∞ `shops`
2. ‚úÖ –ú–æ–¥–µ–ª—å `Shop` (JPA Entity)
3. ‚úÖ –†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π `ShopRepository`
4. ‚úÖ –°–µ—Ä–≤–∏—Å `ShopService`

## ‚è≥ –û–°–¢–ê–õ–û–°–¨:

5. **–û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –º–∞–≥–∞–∑–∏–Ω–∞** (`ShopRegistrationHandler`)
   - –ö–æ–º–∞–Ω–¥–∞ `/register_shop`
   - –ü–æ—à–∞–≥–æ–≤—ã–π –¥–∏–∞–ª–æ–≥: –Ω–∞–∑–≤–∞–Ω–∏–µ ‚Üí –∞–¥—Ä–µ—Å ‚Üí —Ç–µ–ª–µ—Ñ–æ–Ω
   - State management (–∑–∞–ø–æ–º–∏–Ω–∞—Ç—å, –Ω–∞ –∫–∞–∫–æ–º —à–∞–≥–µ —é–∑–µ—Ä)
   - –í—ã–∑–æ–≤ `ShopService.createShopForUser(...)`

6. **–¢–∞–±–ª–∏—Ü–∞ –∑–∞–∫–∞–∑–æ–≤** (`orders`) ‚Äî –º–∏–≥—Ä–∞—Ü–∏—è V3
   - –í—Å–µ –ø–æ–ª—è –∑–∞–∫–∞–∑–∞: –ø–æ–ª—É—á–∞—Ç–µ–ª—å, –∞–¥—Ä–µ—Å, —Ü–µ–Ω–∞, —Å—Ç–∞—Ç—É—Å –∏ —Ç.–¥.

7. **–ú–æ–¥–µ–ª—å Order** + `OrderRepository` + `OrderService`
   - –°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–∫–∞–∑–∞
   - –°–º–µ–Ω–∞ —Å—Ç–∞—Ç—É—Å–∞
   - –ü–æ–∏—Å–∫ –∑–∞–∫–∞–∑–æ–≤

8. **–û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–∫–∞–∑–∞** (`OrderCreationHandler`)
   - –ö–æ–º–∞–Ω–¥–∞ `/create_order`
   - –ü–æ—à–∞–≥–æ–≤—ã–π –≤–≤–æ–¥ –¥–∞–Ω–Ω—ã—Ö –∑–∞–∫–∞–∑–∞

9. **–ü—Ä–æ—Å–º–æ—Ç—Ä –∑–∞–∫–∞–∑–æ–≤ –º–∞–≥–∞–∑–∏–Ω–æ–º** (`OrderListHandler`)
   - –ö–æ–º–∞–Ω–¥–∞ `/my_orders`
   - –°–ø–∏—Å–æ–∫ –∑–∞–∫–∞–∑–æ–≤ —Å –∫–Ω–æ–ø–∫–∞–º–∏

10. **–ë–∞–∑–æ–≤—ã–π –ø—Ä–æ—Å–º–æ—Ç—Ä –∫—É—Ä—å–µ—Ä–∞** (—É–ø—Ä–æ—â—ë–Ω–Ω—ã–π)
    - –ö–æ–≥–¥–∞ –∫—É—Ä—å–µ—Ä –≤–∑—è–ª –∑–∞–∫–∞–∑ ‚Äî –º–∞–≥–∞–∑–∏–Ω –≤–∏–¥–∏—Ç –µ–≥–æ —Ç–µ–ª–µ—Ñ–æ–Ω

---

## –°–ª–µ–¥—É—é—â–∏–π —à–∞–≥:

**–û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –º–∞–≥–∞–∑–∏–Ω–∞** ‚Äî –ø–æ—à–∞–≥–æ–≤—ã–π –¥–∏–∞–ª–æ–≥:
1. –Æ–∑–µ—Ä –ø–∏—à–µ—Ç `/register_shop`.
2. –ë–æ—Ç: "–í–≤–µ–¥–∏ –Ω–∞–∑–≤–∞–Ω–∏–µ –º–∞–≥–∞–∑–∏–Ω–∞".
3. –Æ–∑–µ—Ä: "–¶–≤–µ—Ç—ã –Ω–∞ –õ–µ–Ω–∏–Ω–∞".
4. –ë–æ—Ç: "–í–≤–µ–¥–∏ –∞–¥—Ä–µ—Å –∑–∞–±–æ—Ä–∞".
5. –Æ–∑–µ—Ä: "—É–ª. –õ–µ–Ω–∏–Ω–∞, 10".
6. –ë–æ—Ç: "–í–≤–µ–¥–∏ —Ç–µ–ª–µ—Ñ–æ–Ω (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)".
7. –Æ–∑–µ—Ä: "+79991234567".
8. –ë–æ—Ç: "‚úÖ –ú–∞–≥–∞–∑–∏–Ω –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω! –û–∂–∏–¥–∞–π –∞–∫—Ç–∏–≤–∞—Ü–∏–∏."

–î–ª—è —ç—Ç–æ–≥–æ –Ω—É–∂–µ–Ω **state management** ‚Äî –∑–∞–ø–æ–º–∏–Ω–∞—Ç—å, –Ω–∞ –∫–∞–∫–æ–º —à–∞–≥–µ –¥–∏–∞–ª–æ–≥–∞ —é–∑–µ—Ä.

---

**–ò—Ç–æ–≥–æ:** –ú—ã –Ω–∞ –ø–æ–ª–ø—É—Ç–∏. –ë–∞–∑–æ–≤–∞—è –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–ª—è –º–∞–≥–∞–∑–∏–Ω–æ–≤ –≥–æ—Ç–æ–≤–∞ (–º–æ–¥–µ–ª—å, —Ä–µ–ø–æ, —Å–µ—Ä–≤–∏—Å). –û—Å—Ç–∞–ª–æ—Å—å —Å–¥–µ–ª–∞—Ç—å –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∏ –ø–µ—Ä–µ–π—Ç–∏ –∫ –∑–∞–∫–∞–∑–∞–º.
